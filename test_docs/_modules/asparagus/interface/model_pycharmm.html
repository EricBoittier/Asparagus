<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>asparagus.interface.model_pycharmm &mdash; Asparagus bundle 0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js?v=e031e9a9"></script>
        <script src="../../../_static/doctools.js?v=888ff710"></script>
        <script src="../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="author" title="About these documents" href="../../../about.html" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Asparagus bundle
          </a>
              <div class="version">
                0.1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../config_file.html">Configuration File Structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../main.html">Main file</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../about.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contribute.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../example.html">Examples</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Asparagus bundle</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">asparagus.interface.model_pycharmm</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for asparagus.interface.model_pycharmm</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">ctypes</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Any</span>

<span class="kn">import</span> <span class="nn">torch</span>

<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">utils</span>
<span class="c1">#from .. import layers</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;PyCharmm_Calculator&#39;</span><span class="p">]</span>

<span class="n">CHARMM_calculator_units</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;positions&#39;</span><span class="p">:</span>        <span class="s1">&#39;Ang&#39;</span><span class="p">,</span>
    <span class="s1">&#39;energy&#39;</span><span class="p">:</span>           <span class="s1">&#39;kcal/mol&#39;</span><span class="p">,</span>
    <span class="s1">&#39;forces&#39;</span><span class="p">:</span>           <span class="s1">&#39;kcal/mol/Ang&#39;</span><span class="p">,</span>
    <span class="s1">&#39;hessian&#39;</span><span class="p">:</span>          <span class="s1">&#39;kcal/mol/Ang/Ang&#39;</span><span class="p">,</span>
    <span class="s1">&#39;charge&#39;</span><span class="p">:</span>           <span class="s1">&#39;e&#39;</span><span class="p">,</span>
    <span class="s1">&#39;atomic_charges&#39;</span><span class="p">:</span>   <span class="s1">&#39;e&#39;</span><span class="p">,</span>
    <span class="s1">&#39;dipole&#39;</span><span class="p">:</span>           <span class="s1">&#39;e*Ang&#39;</span><span class="p">,</span>
    <span class="p">}</span>


<div class="viewcode-block" id="PyCharmm_Calculator"><a class="viewcode-back" href="../../../api/asparagus.interface.html#asparagus.interface.model_pycharmm.PyCharmm_Calculator">[docs]</a><span class="k">class</span> <span class="nc">PyCharmm_Calculator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculator for the interface between PyCHARMM and Asparagus.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model_calculator: object</span>
<span class="sd">        Asparagus model calculator object with already loaded parameter set</span>
<span class="sd">    ml_atom_indices: list(int)</span>
<span class="sd">        List of atom indices referring to the ML treated atoms in the total </span>
<span class="sd">        system loaded in CHARMM</span>
<span class="sd">    ml_atomic_numbers: list(int)</span>
<span class="sd">        Respective atomic numbers of the ML atom selection</span>
<span class="sd">    ml_charge: float</span>
<span class="sd">        Total charge of the partial ML atom selection</span>
<span class="sd">    ml_fluctuating_charges: bool</span>
<span class="sd">        If True, electrostatic interaction contribution between the MM atom</span>
<span class="sd">        charges and the model predicted ML atom charges. Else, the ML atom</span>
<span class="sd">        charges are considered fixed as defined by the CHARMM psf file.</span>
<span class="sd">    mlmm_atomic_charges: list(float)</span>
<span class="sd">        List of all atomic charges of the system loaded to CHARMM.</span>
<span class="sd">        If &#39;ml_fluctuating_charges&#39; is True, the atomic charges of the ML</span>
<span class="sd">        atoms are ignored (usually set to zero anyways) and their atomic</span>
<span class="sd">        charge prediction is used.</span>
<span class="sd">    mlmm_rcut: float</span>
<span class="sd">        Max. cutoff distance for ML/MM electrostatic interactions</span>
<span class="sd">    mlmm_width: float</span>
<span class="sd">        Cutoff width for ML/MM electrostatic interactions</span>
<span class="sd">    dtype: dtype object, optional, default torch.float64</span>
<span class="sd">        Data type of the calculator</span>
<span class="sd">    **kwargs</span>
<span class="sd">        Additional keyword arguments.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">model_calculator</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">object</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">object</span><span class="p">]],</span>
        <span class="n">ml_atom_indices</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">ml_atomic_numbers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">ml_charge</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">ml_fluctuating_charges</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">mlmm_atomic_charges</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">mlmm_rcut</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">mlmm_width</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>

        <span class="c1"># Assign dtype</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype</span>

        <span class="c1">################################</span>
        <span class="c1"># # # Set PyCHARMM Options # # #</span>
        <span class="c1">################################</span>
        
        <span class="c1"># Number of machine learning (ML) atoms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ml_num_atoms</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
            <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">ml_atom_indices</span><span class="p">)],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>

        <span class="c1"># ML atom indices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ml_atom_indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">ml_atom_indices</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ml_atom_indices</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="c1"># ML atomic numbers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ml_atomic_numbers</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
            <span class="n">ml_atomic_numbers</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        
        <span class="c1"># ML atom total charge</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ml_charge</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">ml_charge</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

        <span class="c1"># ML fluctuating charges</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ml_fluctuating_charges</span> <span class="o">=</span> <span class="n">ml_fluctuating_charges</span>

        <span class="c1"># ML and MM atom charges</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mlmm_atomic_charges</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
            <span class="n">mlmm_atomic_charges</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

        <span class="c1"># ML and MM number of atoms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mlmm_num_atoms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mlmm_atomic_charges</span><span class="p">)</span>
        
        <span class="c1"># ML and MM atom indices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mlmm_atom_indices</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mlmm_num_atoms</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mlmm_atom_indices</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ml_atom_indices</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ml_atomic_numbers</span>
        
        <span class="c1"># ML atoms - atom indices pointing from MLMM position to ML position</span>
        <span class="c1"># 0, 1, 2 ..., ml_num_atoms: ML atom 1, 2, 3 ... ml_num_atoms + 1</span>
        <span class="c1"># ml_num_atoms + 1: MM atoms</span>
        <span class="n">ml_idxp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mlmm_num_atoms</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ia</span><span class="p">,</span> <span class="n">ai</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ml_atom_indices</span><span class="p">):</span>
            <span class="n">ml_idxp</span><span class="p">[</span><span class="n">ai</span><span class="p">]</span> <span class="o">=</span> <span class="n">ia</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ml_idxp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">ml_idxp</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        
        <span class="c1"># Running number list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mlmm_idxa</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mlmm_num_atoms</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>

        <span class="c1"># Non-bonding interaction range</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mlmm_rcut</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">mlmm_rcut</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mlmm_rcut2</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">mlmm_rcut</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mlmm_width</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">mlmm_width</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

        <span class="c1">################################</span>
        <span class="c1"># # # Set Model Calculator # # #</span>
        <span class="c1">################################</span>

        <span class="c1"># In case of model calculator is a list of models</span>
        <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">is_array_like</span><span class="p">(</span><span class="n">model_calculator</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_calculator</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_calculator_list</span> <span class="o">=</span> <span class="n">model_calculator</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_calculator_num</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_calculator</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_ensemble</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_calculator</span> <span class="o">=</span> <span class="n">model_calculator</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_calculator_list</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_calculator_num</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_ensemble</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Get implemented model properties</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_ensemble</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">implemented_properties</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model_calculator_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">model_properties</span><span class="p">)</span>
            <span class="c1"># Check model properties and set evaluation mode</span>
            <span class="k">for</span> <span class="n">ic</span><span class="p">,</span> <span class="n">calc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_calculator_list</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">implemented_properties</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">prop</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">calc</span><span class="o">.</span><span class="n">model_properties</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Model calculator </span><span class="si">{</span><span class="n">ic</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2"> does not predict &quot;</span>
                            <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;property </span><span class="si">{</span><span class="n">prop</span><span class="si">:</span><span class="s2">s</span><span class="si">}</span><span class="s2">!</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="o">+</span> <span class="s2">&quot;Specify &#39;implemented_properties&#39; with &quot;</span>
                            <span class="o">+</span> <span class="s2">&quot;properties all model calculator support.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">implemented_properties</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model_calculator</span><span class="o">.</span><span class="n">model_properties</span><span class="p">)</span>

        <span class="c1">#############################</span>
        <span class="c1"># # # Set ML/MM Options # # #</span>
        <span class="c1">#############################</span>

        <span class="c1"># Get model interaction cutoff and set evaluation mode</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_ensemble</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interaction_cutoff</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">for</span> <span class="n">calc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_calculator_list</span><span class="p">:</span>
                <span class="n">cutoff</span> <span class="o">=</span> <span class="n">calc</span><span class="o">.</span><span class="n">model_interaction_cutoff</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interaction_cutoff</span> <span class="o">&lt;</span> <span class="n">cutoff</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">interaction_cutoff</span> <span class="o">=</span> <span class="n">cutoff</span>
                <span class="n">calc</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interaction_cutoff</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model_calculator</span><span class="o">.</span><span class="n">model_interaction_cutoff</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_calculator</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

        <span class="c1"># Check cutoff of CHARMM and the ML model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_rcut</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">interaction_cutoff</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlmm_rcut</span><span class="p">])</span>

        <span class="c1"># Get property unit conversions from model units to CHARMM units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_unit_properties</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_calculator</span><span class="o">.</span><span class="n">model_unit_properties</span><span class="p">)</span>
        <span class="c1">#self.charmm_unit_properties = {}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model2charmm_unit_conversion</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Positions unit conversion</span>
        <span class="n">conversion</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">check_units</span><span class="p">(</span>
            <span class="n">CHARMM_calculator_units</span><span class="p">[</span><span class="s1">&#39;positions&#39;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model_unit_properties</span><span class="p">[</span><span class="s1">&#39;positions&#39;</span><span class="p">])</span>
        <span class="c1">#self.charmm_unit_properties[&#39;positions&#39;] = conversion</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model2charmm_unit_conversion</span><span class="p">[</span><span class="s1">&#39;positions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">conversion</span>

        <span class="c1"># Implemented property units conversion</span>
        <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">implemented_properties</span><span class="p">:</span>
            <span class="n">conversion</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">check_units</span><span class="p">(</span>
                <span class="n">CHARMM_calculator_units</span><span class="p">[</span><span class="n">prop</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model_unit_properties</span><span class="p">[</span><span class="n">prop</span><span class="p">])</span>
            <span class="c1">#self.charmm_unit_properties[prop] = conversion</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">model2charmm_unit_conversion</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span> <span class="o">=</span> <span class="n">conversion</span>

        <span class="c1"># Initialize the non-bonded interaction calculator</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ml_fluctuating_charges</span><span class="p">:</span>

            <span class="c1"># Convert 1/(2*4*pi*epsilon) from e**2/eV/Ang to CHARMM units</span>
            <span class="n">kehalf_ase</span> <span class="o">=</span> <span class="mf">7.199822675975274</span>
            <span class="n">conversion</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">check_units</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model_unit_properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;energy&#39;</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kehalf</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
                <span class="p">[</span><span class="n">kehalf_ase</span><span class="o">*</span><span class="mf">1.</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">conversion</span><span class="o">/</span><span class="mf">1.</span><span class="p">],</span>
                <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">electrostatics_calc</span> <span class="o">=</span> <span class="n">Electrostatic_shift</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mlmm_rcut</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mlmm_width</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">max_rcut</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ml_idxp</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mlmm_atomic_charges</span><span class="p">,</span>
                <span class="n">kehalf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kehalf</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">electrostatics_calc</span> <span class="o">=</span> <span class="kc">None</span>

<span class="c1"># Note: It needs to create a dictionary that contains the following values:</span>
<span class="c1">#         atoms_number = batch[&#39;atoms_number&#39;]</span>
<span class="c1">#         atomic_numbers = batch[&#39;atomic_numbers&#39;]</span>
<span class="c1">#         positions = batch[&#39;positions&#39;]</span>
<span class="c1">#         idx_i = batch[&#39;idx_i&#39;]</span>
<span class="c1">#         idx_j = batch[&#39;idx_j&#39;]</span>
<span class="c1">#         charge = batch[&#39;charge&#39;]</span>
<span class="c1">#         idx_seg = batch[&#39;atoms_seg&#39;]</span>
<span class="c1">#         pbc_offset = batch.get(&#39;pbc_offset&#39;)</span>
<div class="viewcode-block" id="PyCharmm_Calculator.calculate_charmm"><a class="viewcode-back" href="../../../api/asparagus.interface.html#asparagus.interface.model_pycharmm.PyCharmm_Calculator.calculate_charmm">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_charmm</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">Natom</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">Ntrans</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">Natim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">idxp</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">x</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">y</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">z</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">dx</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">dy</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">dz</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">Nmlp</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">Nmlmmp</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">idxi</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">idxj</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">idxjp</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">idxu</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">idxv</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">idxup</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">idxvp</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function matches the signature of the corresponding MLPot class in</span>
<span class="sd">        PyCHARMM.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Natom: int</span>
<span class="sd">            Number of atoms in primary cell</span>
<span class="sd">        Ntrans: int</span>
<span class="sd">            Number of unit cells (primary + images)</span>
<span class="sd">        Natim: int</span>
<span class="sd">            Number of atoms in primary and image unit cells</span>
<span class="sd">        idxp: list(int)</span>
<span class="sd">            List of primary and primary to image atom index pointer</span>
<span class="sd">        x: list(float)</span>
<span class="sd">            List of x coordinates </span>
<span class="sd">        y: list(float)</span>
<span class="sd">            List of y coordinates</span>
<span class="sd">        z: list(float)</span>
<span class="sd">            List of z coordinates</span>
<span class="sd">        dx: list(float)</span>
<span class="sd">            List of x derivatives</span>
<span class="sd">        dy: list(float)</span>
<span class="sd">            List of y derivatives</span>
<span class="sd">        dz: list(float)</span>
<span class="sd">            List of z derivatives</span>
<span class="sd">        Nmlp: int</span>
<span class="sd">            Number of ML atom pairs in the system</span>
<span class="sd">        Nmlmmp: int</span>
<span class="sd">            Number of ML/MM atom pairs in the system</span>
<span class="sd">        idxi: list(int)</span>
<span class="sd">            List of ML atom indices for ML potential</span>
<span class="sd">        idxj: list(int)</span>
<span class="sd">            List of ML atom indices for ML potential</span>
<span class="sd">        idxjp: list(int)</span>
<span class="sd">            List of image to primary ML atom index pointer</span>
<span class="sd">        idxu: list(int)</span>
<span class="sd">            List of ML atom indices for ML-MM embedding potential</span>
<span class="sd">        idxv: list(int)</span>
<span class="sd">            List of MM atom indices for ML-MM embedding potential</span>
<span class="sd">        idxup: list(int)</span>
<span class="sd">            List of image to primary ML atom index pointer</span>
<span class="sd">        idxvp: list(int)</span>
<span class="sd">            List of image to primary MM atom index pointer</span>

<span class="sd">        Return</span>
<span class="sd">        ------</span>
<span class="sd">        float</span>
<span class="sd">            ML potential plus ML-MM embedding potential</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Assign all positions</span>
        <span class="k">if</span> <span class="n">Ntrans</span><span class="p">:</span>
            <span class="n">mlmm_R</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">x</span><span class="p">[:</span><span class="n">Natim</span><span class="p">],</span> <span class="n">y</span><span class="p">[:</span><span class="n">Natim</span><span class="p">],</span> <span class="n">z</span><span class="p">[:</span><span class="n">Natim</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span>
                <span class="p">),</span>
                <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">mlmm_idxp</span> <span class="o">=</span> <span class="n">idxp</span><span class="p">[:</span><span class="n">Natim</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mlmm_R</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">x</span><span class="p">[:</span><span class="n">Natom</span><span class="p">],</span> <span class="n">y</span><span class="p">[:</span><span class="n">Natom</span><span class="p">],</span> <span class="n">z</span><span class="p">[:</span><span class="n">Natom</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dtype</span>
                <span class="p">),</span>
                <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">mlmm_idxp</span> <span class="o">=</span> <span class="n">idxp</span><span class="p">[:</span><span class="n">Natom</span><span class="p">]</span>
        <span class="n">mlmm_R</span><span class="o">.</span><span class="n">requires_grad_</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Assign indices</span>
        <span class="c1"># ML-ML pair indices</span>
        <span class="n">ml_idxi</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">idxi</span><span class="p">[:</span><span class="n">Nmlp</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="n">ml_idxj</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">idxj</span><span class="p">[:</span><span class="n">Nmlp</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="n">ml_idxjp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">idxjp</span><span class="p">[:</span><span class="n">Nmlp</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="n">atoms_seg</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ml_num_atoms</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="c1"># ML-MM pair indices and pointer</span>
        <span class="n">mlmm_idxu</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
            <span class="n">idxu</span><span class="p">[:</span><span class="n">Nmlmmp</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="n">mlmm_idxv</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
            <span class="n">idxv</span><span class="p">[:</span><span class="n">Nmlmmp</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="n">mlmm_idxup</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
            <span class="n">idxup</span><span class="p">[:</span><span class="n">Nmlmmp</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="n">mlmm_idxvp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span>
            <span class="n">idxvp</span><span class="p">[:</span><span class="n">Nmlmmp</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>

        <span class="c1"># Create batch for evaluating the model</span>
        <span class="n">atoms_batch</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">atoms_batch</span><span class="p">[</span><span class="s1">&#39;atoms_number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ml_num_atoms</span>
        <span class="n">atoms_batch</span><span class="p">[</span><span class="s1">&#39;atomic_numbers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ml_atomic_numbers</span>
        <span class="n">atoms_batch</span><span class="p">[</span><span class="s1">&#39;positions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mlmm_R</span>
        <span class="n">atoms_batch</span><span class="p">[</span><span class="s1">&#39;charge&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ml_charge</span>
        <span class="n">atoms_batch</span><span class="p">[</span><span class="s1">&#39;idx_i&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ml_idxi</span>
        <span class="n">atoms_batch</span><span class="p">[</span><span class="s1">&#39;idx_j&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ml_idxj</span>
        <span class="n">atoms_batch</span><span class="p">[</span><span class="s1">&#39;atoms_seg&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atoms_seg</span>
        
        <span class="c1"># PBC options</span>
        <span class="n">atoms_batch</span><span class="p">[</span><span class="s1">&#39;pbc_offset&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">atoms_batch</span><span class="p">[</span><span class="s1">&#39;atom_indices&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ml_atom_indices</span>
        <span class="n">atoms_batch</span><span class="p">[</span><span class="s1">&#39;idx_jp&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ml_idxjp</span>
        <span class="n">atoms_batch</span><span class="p">[</span><span class="s1">&#39;idx_p&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ml_idxp</span>

        <span class="c1"># Compute model properties</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_ensemble</span><span class="p">:</span>

            <span class="c1"># TODO Test</span>
            <span class="k">for</span> <span class="n">ic</span><span class="p">,</span> <span class="n">calc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_calculator_list</span><span class="p">):</span>
                <span class="n">results</span><span class="p">[</span><span class="n">ic</span><span class="p">]</span> <span class="o">=</span> <span class="n">calc</span><span class="p">(</span><span class="n">atoms_batch</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">implemented_properties</span><span class="p">:</span>
                <span class="n">prop_std</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;std_</span><span class="si">{</span><span class="n">prop</span><span class="si">:</span><span class="s2">s</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">results</span><span class="p">[</span><span class="n">prop_std</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">std_mean</span><span class="p">(</span>
                    <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span>
                        <span class="p">[</span>
                            <span class="n">results</span><span class="p">[</span><span class="n">ic</span><span class="p">][</span><span class="n">prop</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">ic</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_calculator_num</span><span class="p">)</span>
                        <span class="p">],</span>
                        <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                    <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_calculator</span><span class="p">(</span><span class="n">atoms_batch</span><span class="p">)</span>

        <span class="c1"># Unit conversion</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">implemented_properties</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">results</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">model2charmm_unit_conversion</span><span class="p">[</span><span class="n">prop</span><span class="p">])</span>

        <span class="c1"># Apply dtype conversion</span>
        <span class="n">E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;energy&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">ml_F</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;forces&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data_as</span><span class="p">(</span>
            <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">))</span>

        <span class="c1"># Add forces to CHARMM derivative arrays</span>
        <span class="k">for</span> <span class="n">ai</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ml_atom_indices</span><span class="p">:</span>
            <span class="n">ii</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">ai</span>
            <span class="n">dx</span><span class="p">[</span><span class="n">ai</span><span class="p">]</span> <span class="o">-=</span> <span class="n">ml_F</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
            <span class="n">dy</span><span class="p">[</span><span class="n">ai</span><span class="p">]</span> <span class="o">-=</span> <span class="n">ml_F</span><span class="p">[</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">dz</span><span class="p">[</span><span class="n">ai</span><span class="p">]</span> <span class="o">-=</span> <span class="n">ml_F</span><span class="p">[</span><span class="n">ii</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>
        <span class="c1"># Calculate electrostatic energy and force contribution</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">electrostatics_calc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            
            <span class="n">mlmm_Eele</span><span class="p">,</span> <span class="n">mlmm_gradient</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">electrostatics_calc</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                <span class="n">mlmm_R</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;atomic_charges&#39;</span><span class="p">],</span>
                <span class="n">mlmm_idxu</span><span class="p">,</span>
                <span class="n">mlmm_idxv</span><span class="p">,</span>
                <span class="n">mlmm_idxup</span><span class="p">,</span>
                <span class="n">mlmm_idxvp</span><span class="p">)</span>
            
            <span class="c1"># Add electrostatic interaction potential to ML energy</span>
            <span class="n">E</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="n">mlmm_Eele</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">model2charmm_unit_conversion</span><span class="p">[</span><span class="s1">&#39;energy&#39;</span><span class="p">]</span>
                <span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

            <span class="c1"># Apply dtype conversion</span>
            <span class="n">mlmm_F</span> <span class="o">=</span> <span class="p">(</span>
                <span class="o">-</span><span class="n">mlmm_gradient</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">model2charmm_unit_conversion</span><span class="p">[</span><span class="s1">&#39;forces&#39;</span><span class="p">]</span>
                <span class="p">)</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data_as</span><span class="p">(</span>
                    <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">)</span>
                    <span class="p">)</span>

            <span class="c1"># Add electrostatic forces to CHARMM derivative arrays</span>
            <span class="k">for</span> <span class="n">ia</span><span class="p">,</span> <span class="n">ai</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mlmm_idxp</span><span class="p">):</span>
                <span class="n">ii</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">ia</span>
                <span class="n">dx</span><span class="p">[</span><span class="n">ai</span><span class="p">]</span> <span class="o">-=</span> <span class="n">mlmm_F</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span>
                <span class="n">dy</span><span class="p">[</span><span class="n">ai</span><span class="p">]</span> <span class="o">-=</span> <span class="n">mlmm_F</span><span class="p">[</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">dz</span><span class="p">[</span><span class="n">ai</span><span class="p">]</span> <span class="o">-=</span> <span class="n">mlmm_F</span><span class="p">[</span><span class="n">ii</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">E</span></div></div>


<span class="k">class</span> <span class="nc">Electrostatic_shift</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">mlmm_rcut</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">mlmm_width</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">max_rcut</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">ml_idxp</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">mlmm_atomic_charges</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">kehalf</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">switch_fn</span><span class="o">=</span><span class="s1">&#39;CHARMM&#39;</span><span class="p">,</span>
    <span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mlmm_rcut</span> <span class="o">=</span> <span class="n">mlmm_rcut</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ml_idxp</span> <span class="o">=</span> <span class="n">ml_idxp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mlmm_atomic_charges</span> <span class="o">=</span> <span class="n">mlmm_atomic_charges</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_rcut2</span> <span class="o">=</span> <span class="n">max_rcut</span><span class="o">**</span><span class="mi">2</span>

        <span class="c1"># Initialize the class for cutoff</span>
        <span class="n">switch_class</span> <span class="o">=</span> <span class="n">layers</span><span class="o">.</span><span class="n">get_cutoff_fn</span><span class="p">(</span><span class="n">switch_fn</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">switch_fn</span> <span class="o">=</span> <span class="n">switch_class</span><span class="p">(</span><span class="n">mlmm_rcut</span><span class="p">,</span> <span class="n">mlmm_width</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kehalf</span> <span class="o">=</span> <span class="n">kehalf</span>

    <span class="k">def</span> <span class="nf">calculate_mlmm_interatomic_distances</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">R</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">idxu</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">idxv</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">idxup</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">idxvp</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">):</span>

        <span class="c1"># Gather positions</span>
        <span class="n">Ru</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="n">idxu</span><span class="p">]</span>
        <span class="n">Rv</span> <span class="o">=</span> <span class="n">R</span><span class="p">[</span><span class="n">idxv</span><span class="p">]</span>
        
        <span class="c1"># Interacting atom pair distances within cutoff</span>
        <span class="n">sum_distances</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">Ru</span> <span class="o">-</span> <span class="n">Rv</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">selection</span> <span class="o">=</span> <span class="n">sum_distances</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_rcut2</span>
        <span class="n">Duv</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sum_distances</span><span class="p">[</span><span class="n">selection</span><span class="p">])</span>
        
        <span class="c1"># Reduce the indexes to consider only interacting pairs (selection)</span>
        <span class="c1"># and point image atom indices to primary atom indices (idx?p)</span>
        <span class="n">idxur</span> <span class="o">=</span> <span class="n">idxup</span><span class="p">[</span><span class="n">selection</span><span class="p">]</span>
        <span class="n">idxvr</span> <span class="o">=</span> <span class="n">idxvp</span><span class="p">[</span><span class="n">selection</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="n">Duv</span><span class="p">,</span> <span class="n">idxur</span><span class="p">,</span> <span class="n">idxvr</span>

    <span class="k">def</span> <span class="nf">electrostatic_energy_per_atom_to_point_charge</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">Duv</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">Qau</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">Qav</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate electrostatic interaction between ML atom charge and MM point</span>
<span class="sd">        charge based on shifted Coulomb potential scheme</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Cutoff weighted reciprocal distance</span>
        <span class="n">switchoff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">switch_fn</span><span class="p">(</span><span class="n">Duv</span><span class="p">)</span>

        <span class="c1"># Shifted Coulomb energy</span>
        <span class="n">qq</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">kehalf</span><span class="o">*</span><span class="n">Qau</span><span class="o">*</span><span class="n">Qav</span>
        <span class="n">Eele</span> <span class="o">=</span> <span class="n">qq</span><span class="o">/</span><span class="n">Duv</span> <span class="o">-</span> <span class="n">qq</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">mlmm_rcut</span><span class="o">*</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">-</span> <span class="n">Duv</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">mlmm_rcut</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">switchoff</span><span class="o">*</span><span class="n">Eele</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">mlmm_R</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">ml_Qa</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">mlmm_idxu</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">mlmm_idxv</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">mlmm_idxup</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
        <span class="n">mlmm_idxvp</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the electrostatic interaction between ML atoms in the </span>
<span class="sd">        primary cell with all MM atoms in the primary or imaginary non-bonded</span>
<span class="sd">        lists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># Calculate ML-MM atom distances</span>
        <span class="n">mlmm_Duv</span><span class="p">,</span> <span class="n">mlmm_idxur</span><span class="p">,</span> <span class="n">mlmm_idxvr</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calculate_mlmm_interatomic_distances</span><span class="p">(</span>
                <span class="n">mlmm_R</span><span class="p">,</span> <span class="n">mlmm_idxu</span><span class="p">,</span> <span class="n">mlmm_idxv</span><span class="p">,</span> <span class="n">mlmm_idxup</span><span class="p">,</span> <span class="n">mlmm_idxvp</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># Point from PyCHARMM ML atom indices to model calculator atom indices</span>
        <span class="n">ml_idxur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ml_idxp</span><span class="p">[</span><span class="n">mlmm_idxur</span><span class="p">]</span>
        
        <span class="c1"># Get ML and MM charges</span>
        <span class="n">ml_Qau</span> <span class="o">=</span> <span class="n">ml_Qa</span><span class="p">[</span><span class="n">ml_idxur</span><span class="p">]</span>
        <span class="n">ml_Qav</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlmm_atomic_charges</span><span class="p">[</span><span class="n">mlmm_idxvr</span><span class="p">]</span>

        <span class="c1"># Calculate electrostatic energy and gradients</span>
        <span class="n">Eele</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">electrostatic_energy_per_atom_to_point_charge</span><span class="p">(</span>
            <span class="n">mlmm_Duv</span><span class="p">,</span> <span class="n">ml_Qau</span><span class="p">,</span> <span class="n">ml_Qav</span><span class="p">)</span>
        <span class="n">Eele_gradient</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">autograd</span><span class="o">.</span><span class="n">grad</span><span class="p">(</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Eele</span><span class="p">),</span>
                <span class="n">mlmm_R</span><span class="p">,</span>
                <span class="n">retain_graph</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">Eele</span><span class="p">,</span> <span class="n">Eele_gradient</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, L.I.Vazquez-Salazar, K. Toepfer &amp; M. Meuwly.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>