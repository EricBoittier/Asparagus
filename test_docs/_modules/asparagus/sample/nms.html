<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>asparagus.sample.nms &mdash; Asparagus bundle 0.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js?v=e031e9a9"></script>
        <script src="../../../_static/doctools.js?v=888ff710"></script>
        <script src="../../../_static/sphinx_highlight.js?v=4825356b"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="author" title="About these documents" href="../../../about.html" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            Asparagus bundle
          </a>
              <div class="version">
                0.1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../config_file.html">Configuration File Structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../main.html">Main file</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../about.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contribute.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../example.html">Examples</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Asparagus bundle</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">asparagus.sample.nms</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for asparagus.sample.nms</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">queue</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Any</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">ase</span>
<span class="kn">from</span> <span class="nn">ase.vibrations</span> <span class="kn">import</span> <span class="n">Vibrations</span> <span class="k">as</span> <span class="n">Vibrations_ASE</span>
<span class="kn">from</span> <span class="nn">ase.vibrations.data</span> <span class="kn">import</span> <span class="n">VibrationsData</span>
<span class="kn">from</span> <span class="nn">ase.constraints</span> <span class="kn">import</span> <span class="n">FixAtoms</span>
<span class="kn">from</span> <span class="nn">ase.parallel</span> <span class="kn">import</span> <span class="n">world</span><span class="p">,</span> <span class="n">paropen</span>
<span class="kn">from</span> <span class="nn">ase</span> <span class="kn">import</span> <span class="n">units</span>

<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">sample</span>
<span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">interface</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;NormalModeScanner&#39;</span><span class="p">,</span> <span class="s1">&#39;NormalModeSampler&#39;</span><span class="p">]</span>


<div class="viewcode-block" id="NormalModeScanner"><a class="viewcode-back" href="../../../api/asparagus.sample.html#asparagus.sample.nms.NormalModeScanner">[docs]</a><span class="k">class</span> <span class="nc">NormalModeScanner</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">Sampler</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Normal Mode Scanning class</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    config: (str, dict, object)</span>
<span class="sd">        Either the path to json file (str), dictionary (dict) or</span>
<span class="sd">        settings.config class object of Asparagus parameters</span>
<span class="sd">    config_file: str, optional, default see settings.default[&#39;config_file&#39;]</span>
<span class="sd">        Path to json file (str)</span>
<span class="sd">    nms_harmonic_energy_step: float, optional, default 0.05</span>
<span class="sd">        Within the harmonic approximation the initial normal mode</span>
<span class="sd">        displacement from the equilibrium positions is scaled to match</span>
<span class="sd">        the potential difference with the given energy value.</span>
<span class="sd">    nms_energy_limits: (float, list(float)), optional, default 1.0</span>
<span class="sd">        Potential energy limit in eV from the initial system conformation</span>
<span class="sd">        to which additional normal mode displacements steps are added.</span>
<span class="sd">        If one numeric value is give, the energy limit is used as upper</span>
<span class="sd">        potential energy limit and the lower limit in case the initial</span>
<span class="sd">        system conformation might not be the global minimum.</span>
<span class="sd">        If a list with two numeric values are given, the first two are the</span>
<span class="sd">        lower and upper potential energy limit, respectively.</span>
<span class="sd">    nms_number_of_coupling: int, optional, default 2</span>
<span class="sd">        Maximum number of coupled normal mode displacements to sample</span>
<span class="sd">        the system conformations.</span>
<span class="sd">    nms_limit_of_steps: int, optional, default 10</span>
<span class="sd">        Maximum limit of coupled normal mode displacements in one direction</span>
<span class="sd">        to sample the system conformations.</span>
<span class="sd">    nms_limit_com_shift: float, optional, default 0.1 Angstrom</span>
<span class="sd">        Center of mass shift threshold to identify translational normal</span>
<span class="sd">        modes from vibrational (and rotational). Normalized Normal modes</span>
<span class="sd">        with a center of mass shift larger than the threshold are not</span>
<span class="sd">        considered in the normal mode scan.</span>
<span class="sd">    nms_save_displacements: bool, optional, default False</span>
<span class="sd">        If True, add results of atom displacement calculations from the normal</span>
<span class="sd">        mode analysis to the dataset.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    object</span>
<span class="sd">        Normal Mode Scanning class object</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Default arguments for sample module</span>
    <span class="n">sample</span><span class="o">.</span><span class="n">Sampler</span><span class="o">.</span><span class="n">_default_args</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
        <span class="s1">&#39;nms_harmonic_energy_step&#39;</span><span class="p">:</span>     <span class="mf">0.05</span><span class="p">,</span>
        <span class="s1">&#39;nms_energy_limits&#39;</span><span class="p">:</span>            <span class="mf">1.0</span><span class="p">,</span>
        <span class="s1">&#39;nms_number_of_coupling&#39;</span><span class="p">:</span>       <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;nms_limit_of_steps&#39;</span><span class="p">:</span>           <span class="mi">10</span><span class="p">,</span>
        <span class="s1">&#39;nms_limit_com_shift&#39;</span><span class="p">:</span>          <span class="mf">0.1</span><span class="p">,</span>
        <span class="s1">&#39;nms_save_displacements&#39;</span><span class="p">:</span>       <span class="kc">False</span>
        <span class="p">})</span>
    
    <span class="c1"># Expected data types of input variables</span>
    <span class="n">sample</span><span class="o">.</span><span class="n">Sampler</span><span class="o">.</span><span class="n">_dtypes_args</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
        <span class="s1">&#39;nms_harmonic_energy_step&#39;</span><span class="p">:</span>     <span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">is_numeric</span><span class="p">],</span>
        <span class="s1">&#39;nms_energy_limits&#39;</span><span class="p">:</span>            <span class="p">[</span>
            <span class="n">utils</span><span class="o">.</span><span class="n">is_numeric</span><span class="p">,</span> <span class="n">utils</span><span class="o">.</span><span class="n">is_numeric_array</span><span class="p">],</span>
        <span class="s1">&#39;nms_number_of_coupling&#39;</span><span class="p">:</span>       <span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">is_numeric</span><span class="p">],</span>
        <span class="s1">&#39;nms_limit_of_steps&#39;</span><span class="p">:</span>           <span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">is_numeric</span><span class="p">],</span>
        <span class="s1">&#39;nms_limit_com_shift&#39;</span><span class="p">:</span>          <span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">is_numeric</span><span class="p">],</span>
        <span class="s1">&#39;nms_save_displacements&#39;</span><span class="p">:</span>       <span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">is_bool</span><span class="p">],</span>
        <span class="p">})</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="nb">object</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">config_file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
        <span class="n">nms_harmonic_energy_step</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">nms_energy_limits</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">nms_number_of_coupling</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">nms_limit_of_steps</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">nms_limit_com_shift</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">nms_save_displacements</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>

        <span class="c1"># Sampler class label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_tag</span> <span class="o">=</span> <span class="s1">&#39;nmscan&#39;</span>

        <span class="c1"># Initialize parent class</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">sample_tag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_tag</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
            <span class="n">config_file</span><span class="o">=</span><span class="n">config_file</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>

        <span class="c1">#################################</span>
        <span class="c1"># # # Check NMS Class Input # # #</span>
        <span class="c1">#################################</span>

        <span class="c1"># Get configuration object</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span>
            <span class="n">config</span><span class="p">,</span> <span class="n">config_file</span><span class="p">,</span> <span class="n">config_from</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        
        <span class="c1"># Check input parameter, set default values if necessary and</span>
        <span class="c1"># update the configuration dictionary</span>
        <span class="n">config_update</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
            <span class="n">instance</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">argitems</span><span class="o">=</span><span class="n">utils</span><span class="o">.</span><span class="n">get_input_args</span><span class="p">(),</span>
            <span class="n">check_default</span><span class="o">=</span><span class="n">utils</span><span class="o">.</span><span class="n">get_default_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample</span><span class="p">),</span>
            <span class="n">check_dtype</span><span class="o">=</span><span class="n">utils</span><span class="o">.</span><span class="n">get_dtype_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Check sample properties for energy property which is required for</span>
        <span class="c1"># normal mode scanning</span>
        <span class="k">if</span> <span class="s1">&#39;energy&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_properties</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sample_properties</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;energy&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;forces&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_properties</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sample_properties</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;forces&#39;</span><span class="p">)</span>

        <span class="c1"># Check potential energy limits</span>
        <span class="k">if</span> <span class="n">utils</span><span class="o">.</span><span class="n">is_numeric</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nms_energy_limits</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nms_energy_limits</span> <span class="o">=</span> <span class="p">[</span>
                <span class="o">-</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nms_energy_limits</span><span class="p">),</span> <span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nms_energy_limits</span><span class="p">)]</span>

        <span class="k">return</span>

<div class="viewcode-block" id="NormalModeScanner.get_info"><a class="viewcode-back" href="../../../api/asparagus.sample.html#asparagus.sample.nms.NormalModeScanner.get_info">[docs]</a>    <span class="k">def</span> <span class="nf">get_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Obtain information about the Normal Mode Scanning class object.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            Dictionary with information about the Normal Mode Scanning class</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">info</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_info</span><span class="p">()</span>
        <span class="n">info</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s1">&#39;nms_harmonic_energy_step&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nms_harmonic_energy_step</span><span class="p">,</span>
            <span class="s1">&#39;nms_energy_limits&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nms_energy_limits</span><span class="p">,</span>
            <span class="s1">&#39;nms_number_of_coupling&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nms_number_of_coupling</span><span class="p">,</span>
            <span class="s1">&#39;nms_limit_com_shift&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nms_limit_com_shift</span><span class="p">,</span>
            <span class="s1">&#39;nms_limit_of_steps&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nms_limit_of_steps</span><span class="p">,</span>
            <span class="s1">&#39;nms_save_displacements&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nms_save_displacements</span>
            <span class="p">})</span>
        <span class="k">return</span> <span class="n">info</span></div>

<div class="viewcode-block" id="NormalModeScanner.run_systems"><a class="viewcode-back" href="../../../api/asparagus.sample.html#asparagus.sample.nms.NormalModeScanner.run_systems">[docs]</a>    <span class="k">def</span> <span class="nf">run_systems</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sample_systems_queue</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">nms_indices</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">nms_exclude_modes</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">nms_frequency_range</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">nms_clean</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform Normal Mode Scanning on the sample system.</span>
<span class="sd">        Iterate over systems using &#39;sample_num_threads&#39; threads.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sample_systems_queue: queue.Queue, optional, default None</span>
<span class="sd">            Queue object including sample systems or where &#39;sample_systems&#39; </span>
<span class="sd">            input will be added. If not defined, an empty queue will be </span>
<span class="sd">            assigned.</span>
<span class="sd">        nms_indices: list[int], optional, default None</span>
<span class="sd">            List of atom indices to include in normal mode analysis.</span>
<span class="sd">            If none, indices if a full list of atom indices with length to the</span>
<span class="sd">            atom number of the system.</span>
<span class="sd">            Atom indices from atoms constraint by FixAtoms are removed from</span>
<span class="sd">            index list and the normal mode analysis.</span>
<span class="sd">        nms_exclude_modes: list[int], optional, default None</span>
<span class="sd">            List of vibrational modes, sorted by wave number, to exclude</span>
<span class="sd">            from the sampling procedure.</span>
<span class="sd">        nms_frequency_range: list[tuple(str, float)], optional, default None</span>
<span class="sd">            Frequency range conditions for normal modes to be included in the</span>
<span class="sd">            scan.</span>
<span class="sd">        nms_clean: bool, optional, default True</span>
<span class="sd">            If True, checkpoint files for atom displacement calculations</span>
<span class="sd">            in {sample_directory}/vib_{isample} will be deleted.</span>
<span class="sd">            Else, results from available  checkpoint files will be used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># Check sample system queue</span>
        <span class="k">if</span> <span class="n">sample_systems_queue</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sample_systems_queue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span>
        
        <span class="c1"># Optimize sample systems or take as normal mode analysis input</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_systems_optimize</span><span class="p">:</span>
            
            <span class="c1"># Add stop flag</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_num_threads</span><span class="p">):</span>
                <span class="n">sample_systems_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s1">&#39;stop&#39;</span><span class="p">)</span>
            
            <span class="c1"># Initialize continuation flag</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thread_keep_going</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span><span class="kc">True</span> <span class="k">for</span> <span class="n">ithread</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_num_threads</span><span class="p">)],</span>
                <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span>
                <span class="p">)</span>

            <span class="c1"># Initialize optimized sample system into queue</span>
            <span class="n">sample_input_queue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_num_threads</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>

                <span class="c1"># Run sample system optimization</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_optimization</span><span class="p">(</span>
                    <span class="n">sample_systems_queue</span><span class="o">=</span><span class="n">sample_systems_queue</span><span class="p">,</span>
                    <span class="n">sample_optimzed_queue</span><span class="o">=</span><span class="n">sample_input_queue</span><span class="p">)</span>
            
            <span class="k">else</span><span class="p">:</span>

                <span class="c1"># Create threads for sample system optimization</span>
                <span class="n">threads</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
                        <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">run_optimization</span><span class="p">,</span>
                        <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span>
                            <span class="s1">&#39;sample_systems_queue&#39;</span><span class="p">:</span> <span class="n">sample_systems_queue</span><span class="p">,</span>
                            <span class="s1">&#39;sample_optimzed_queue&#39;</span><span class="p">:</span> <span class="n">sample_input_queue</span><span class="p">,</span>
                            <span class="s1">&#39;ithread&#39;</span><span class="p">:</span> <span class="n">ithread</span><span class="p">}</span>
                        <span class="p">)</span>
                    <span class="k">for</span> <span class="n">ithread</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_num_threads</span><span class="p">)]</span>

                <span class="c1"># Start threads</span>
                <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
                    <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

                <span class="c1"># Wait for threads to finish</span>
                <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
                    <span class="n">thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            
            <span class="c1"># Set sample system queue as optimized sample system queue</span>
            <span class="n">sample_input_queue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_systems_queue</span>

        <span class="c1"># Run normal mode scanning</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">sample_input_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_system</span><span class="p">(</span>
                <span class="n">sample_input_queue</span><span class="p">,</span>
                <span class="n">nms_indices</span><span class="p">,</span>
                <span class="n">nms_exclude_modes</span><span class="p">,</span>
                <span class="n">nms_frequency_range</span><span class="p">,</span>
                <span class="n">nms_clean</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        
        <span class="k">return</span></div>
    
<div class="viewcode-block" id="NormalModeScanner.run_system"><a class="viewcode-back" href="../../../api/asparagus.sample.html#asparagus.sample.nms.NormalModeScanner.run_system">[docs]</a>    <span class="k">def</span> <span class="nf">run_system</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sample_systems_queue</span><span class="p">:</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">,</span>
        <span class="n">nms_indices</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">nms_exclude_modes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">nms_frequency_range</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span>
        <span class="n">nms_clean</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform Normal Mode Scanning on the sample system.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sample_systems_queue: queue.Queue</span>
<span class="sd">            Queue object including sample systems.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Initialize stored sample counter</span>
        <span class="n">Nsample</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="c1"># Initialize normal mode analysis queue</span>
        <span class="n">sample_calculate_queue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
        
        <span class="c1"># Get sample system for normal mode analysis</span>
        <span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="n">isample</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span> <span class="o">=</span> <span class="n">sample_systems_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

        <span class="c1"># Print sampler info</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;INFO:</span><span class="se">\n</span><span class="s2">Start normal mode scanning of the system &quot;</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;from &#39;</span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">&#39; of index </span><span class="si">{</span><span class="n">index</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        
        <span class="c1"># Get non-fixed atoms indices</span>
        <span class="k">if</span> <span class="n">nms_indices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">atom_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
                <span class="n">system</span><span class="o">.</span><span class="n">get_global_number_of_atoms</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">atom_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nms_indices</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">system</span><span class="o">.</span><span class="n">constraints</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">constraint</span><span class="p">,</span> <span class="n">FixAtoms</span><span class="p">):</span>
                <span class="n">atom_indices</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">atom_indices</span>
                    <span class="k">if</span> <span class="n">idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">constraint</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
        <span class="n">atom_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">atom_indices</span><span class="p">)</span>
        
        <span class="c1"># Prepare system parameter</span>
        <span class="n">Natoms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">atom_indices</span><span class="p">)</span>
        <span class="n">Nmodes</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">Natoms</span>

        <span class="c1"># Initialize Vibration class</span>
        <span class="n">system_vibrations</span> <span class="o">=</span> <span class="n">Vibrations_Asparagus</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">system</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sample_calculator</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sample_calculator_args</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nms_save_displacements</span><span class="p">,</span>
            <span class="n">indices</span><span class="o">=</span><span class="n">atom_indices</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_directory</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;vib_</span><span class="si">{</span><span class="n">isample</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
            <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">nms_clean</span><span class="p">:</span>
            <span class="n">system_vibrations</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>
        
        <span class="c1"># Add jobs to calculation queue</span>
        <span class="n">system_vibrations</span><span class="o">.</span><span class="n">add_calculations</span><span class="p">(</span>
            <span class="n">sample_calculate_queue</span><span class="p">)</span>

        <span class="c1"># Add stop flag</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_num_threads</span><span class="p">):</span>
            <span class="n">sample_calculate_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s1">&#39;stop&#39;</span><span class="p">)</span>
        
        <span class="c1"># Initialize continuation flag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread_keep_going</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="kc">True</span> <span class="k">for</span> <span class="n">ithread</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_num_threads</span><span class="p">)],</span>
            <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span>
            <span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_num_threads</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            
            <span class="c1"># Run job calculations</span>
            <span class="n">system_vibrations</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                <span class="n">sample_calculate_queue</span><span class="p">,</span>
                <span class="n">sample_calculator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_calculator</span><span class="p">,</span>
                <span class="n">sample_calculator_args</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_calculator_args</span><span class="p">)</span>
        
        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># Create threads for job calculations</span>
            <span class="n">threads</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
                    <span class="n">target</span><span class="o">=</span><span class="n">system_vibrations</span><span class="o">.</span><span class="n">run</span><span class="p">,</span>
                    <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">sample_calculate_queue</span><span class="p">,</span> <span class="p">),</span>
                    <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span>
                        <span class="s1">&#39;sample_calculator&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_calculator</span><span class="p">,</span>
                        <span class="s1">&#39;sample_calculator_args&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_calculator_args</span><span class="p">,</span>
                        <span class="s1">&#39;ithread&#39;</span><span class="p">:</span> <span class="n">ithread</span><span class="p">}</span>
                    <span class="p">)</span>
                <span class="k">for</span> <span class="n">ithread</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_num_threads</span><span class="p">)]</span>

            <span class="c1"># Start threads</span>
            <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
                <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

            <span class="c1"># Wait for threads to finish</span>
            <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
                <span class="n">thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

        <span class="c1"># Print sampler info</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;INFO:</span><span class="se">\n</span><span class="s2">Normal mode analysis calculation completed for &quot;</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;the system from &#39;</span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">&#39; of index </span><span class="si">{</span><span class="n">index</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        
        <span class="c1"># Finish normal mode analysis and diagonalize Hessian matrix</span>
        <span class="n">system_vibrations</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        
        <span class="c1"># Get initial (equilibrium) energy of the sampling system</span>
        <span class="n">system_initial_results</span> <span class="o">=</span> <span class="n">system_vibrations</span><span class="o">.</span><span class="n">get_initial_results</span><span class="p">()</span>
        
        <span class="c1"># (Trans. + Rot. + ) Vibrational frequencies in cm**-1</span>
        <span class="n">system_frequencies</span> <span class="o">=</span> <span class="n">system_vibrations</span><span class="o">.</span><span class="n">get_frequencies</span><span class="p">()</span>

        <span class="c1"># (Trans. + Rot. + ) Vibrational modes normalized to 1</span>
        <span class="n">system_modes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="n">system_vibrations</span><span class="o">.</span><span class="n">get_mode</span><span class="p">(</span><span class="n">imode</span><span class="p">)[</span><span class="n">atom_indices</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">Natoms</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="n">system_vibrations</span><span class="o">.</span><span class="n">get_mode</span><span class="p">(</span><span class="n">imode</span><span class="p">)[</span><span class="n">atom_indices</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                    <span class="n">Natoms</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">imode</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nmodes</span><span class="p">)])</span>

        <span class="c1"># Reduced mass per mode (in amu)</span>
        <span class="n">system_redmass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="mf">1.</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="n">system_modes</span><span class="p">[</span><span class="n">imode</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
                <span class="o">/</span> <span class="n">system</span><span class="o">.</span><span class="n">get_masses</span><span class="p">()[</span><span class="n">atom_indices</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">Natoms</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">imode</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nmodes</span><span class="p">)])</span>

        <span class="c1"># Force constant per mode (in eV/Angstrom**2)</span>
        <span class="n">system_forceconst</span> <span class="o">=</span> <span class="p">(</span>
            <span class="mf">4.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">system_frequencies</span><span class="p">)</span><span class="o">*</span><span class="mf">1.e2</span><span class="o">*</span><span class="n">units</span><span class="o">.</span><span class="n">_c</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
            <span class="o">*</span> <span class="n">system_redmass</span><span class="o">*</span><span class="n">units</span><span class="o">.</span><span class="n">_amu</span><span class="o">*</span><span class="n">units</span><span class="o">.</span><span class="n">J</span><span class="o">*</span><span class="mf">1.e-20</span><span class="p">)</span>

        <span class="c1"># Compute and store equilibrium positions and center of mass,</span>
        <span class="c1"># moments of inertia and principle axis of inertia</span>
        <span class="n">system_init_positions</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">get_positions</span><span class="p">()</span>
        <span class="n">system_init_com</span> <span class="o">=</span> <span class="n">system</span><span class="p">[</span><span class="n">atom_indices</span><span class="p">]</span><span class="o">.</span><span class="n">get_center_of_mass</span><span class="p">()</span>

        <span class="c1"># Compute and compare same quantities for displaced system</span>
        <span class="n">system_com_shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">Nmodes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">imode</span><span class="p">,</span> <span class="n">mode</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">system_modes</span><span class="p">):</span>

            <span class="c1"># COM shift</span>
            <span class="n">system_mode_positions</span> <span class="o">=</span> <span class="n">system_init_positions</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">system_mode_positions</span><span class="p">[</span><span class="n">atom_indices</span><span class="p">]</span> <span class="o">+=</span> <span class="n">mode</span>
            <span class="n">system</span><span class="o">.</span><span class="n">set_positions</span><span class="p">(</span><span class="n">system_mode_positions</span><span class="p">,</span> <span class="n">apply_constraint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">system_displ_com</span> <span class="o">=</span> <span class="n">system</span><span class="p">[</span><span class="n">atom_indices</span><span class="p">]</span><span class="o">.</span><span class="n">get_center_of_mass</span><span class="p">()</span>
            <span class="n">system_com_shift</span><span class="p">[</span><span class="n">imode</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="p">(</span><span class="n">system_init_com</span> <span class="o">-</span> <span class="n">system_displ_com</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

        <span class="c1"># Reset system positions</span>
        <span class="n">system</span><span class="o">.</span><span class="n">set_positions</span><span class="p">(</span><span class="n">system_init_positions</span><span class="p">)</span>

        <span class="c1"># Vibrational modes are assumed with center of mass shifts smaller</span>
        <span class="c1"># than 1.e-1 Angstrom displacement</span>
        <span class="n">system_vib_modes</span> <span class="o">=</span> <span class="n">system_com_shift</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">nms_limit_com_shift</span>
        
        <span class="c1"># Apply exclusion list if defined</span>
        <span class="k">if</span> <span class="n">nms_exclude_modes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">imode</span> <span class="ow">in</span> <span class="n">nms_exclude_modes</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">imode</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">system_vib_modes</span><span class="p">):</span>
                    <span class="n">system_vib_modes</span><span class="p">[</span><span class="n">imode</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;WARNING:</span><span class="se">\n</span><span class="s2">Vibrational mode </span><span class="si">{</span><span class="n">imode</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2"> in the &quot;</span>
                        <span class="o">+</span> <span class="s2">&quot;exclusion list is larger than the number of &quot;</span>
                        <span class="o">+</span> <span class="s2">&quot;vibrational modes!&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">nms_frequency_range</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            
            <span class="c1"># Initially include all modes</span>
            <span class="n">include_modes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">system_vib_modes</span><span class="p">)</span>
            
            <span class="c1"># Iterate over all exclusion conditions</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="n">frequency</span><span class="p">)</span> <span class="ow">in</span> <span class="n">nms_frequency_range</span><span class="p">:</span>
                
                <span class="c1"># Modes are still include if conditions are matched</span>
                <span class="k">if</span> <span class="n">condition</span> <span class="o">==</span> <span class="s1">&#39;&lt;&#39;</span><span class="p">:</span>
                    <span class="n">include_modes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                        <span class="n">include_modes</span><span class="p">,</span> 
                        <span class="n">system_frequencies</span> <span class="o">&lt;</span> <span class="n">frequency</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">condition</span> <span class="o">==</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">:</span>
                    <span class="n">include_modes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                        <span class="n">include_modes</span><span class="p">,</span> 
                        <span class="n">system_frequencies</span> <span class="o">&lt;=</span> <span class="n">frequency</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">condition</span> <span class="o">==</span> <span class="s1">&#39;&gt;=&#39;</span><span class="p">:</span>
                    <span class="n">include_modes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                        <span class="n">include_modes</span><span class="p">,</span> 
                        <span class="n">system_frequencies</span> <span class="o">&gt;=</span> <span class="n">frequency</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">condition</span> <span class="o">==</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">:</span>
                    <span class="n">include_modes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                        <span class="n">include_modes</span><span class="p">,</span> 
                        <span class="n">system_frequencies</span> <span class="o">&gt;=</span> <span class="n">frequency</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">SyntaxError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Normal mode selection condition &#39;</span><span class="si">{</span><span class="n">condition</span><span class="si">}</span><span class="s2">&#39; in &quot;</span>
                        <span class="o">+</span> <span class="s2">&quot;&#39;nms_frequency_range&#39; selection input is not &quot;</span>
                        <span class="o">+</span> <span class="s2">&quot;recognized! Choose between (&#39;&lt;&#39;, &#39;&lt;=&#39;, &#39;&gt;=&#39;, &#39;&gt;&#39;).&quot;</span><span class="p">)</span>
            
            <span class="c1"># Combine normal mode exclusion list</span>
            <span class="n">system_vib_modes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">system_vib_modes</span><span class="p">,</span> <span class="n">include_modes</span><span class="p">)</span>

        <span class="c1"># Displacement factor for energy step (in eV)</span>
        <span class="n">system_displfact</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
            <span class="mf">2.</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">nms_harmonic_energy_step</span><span class="o">/</span><span class="n">system_forceconst</span><span class="p">)</span>

        <span class="c1"># Add normal mode analysis results to log file</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Start Normal Mode Scanning at system: &quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_data_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">system</span><span class="o">.</span><span class="n">get_chemical_formula</span><span class="p">()</span><span class="si">:</span><span class="s2">s</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_data_file</span><span class="si">:</span><span class="s2">s</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot; Index | Frequency (cm**-1) | Vibration (CoM displacemnt)</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;---------------------------------------------------------</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">ivib</span><span class="p">,</span> <span class="n">freq</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">system_frequencies</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">ivib</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">:</span><span class="s2">5d</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">freq</span><span class="si">:</span><span class="s2">18.2f</span><span class="si">}</span><span class="s2"> |&quot;</span>
            <span class="k">if</span> <span class="n">system_vib_modes</span><span class="p">[</span><span class="n">ivib</span><span class="p">]:</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;   x   (</span><span class="si">{</span><span class="n">system_com_shift</span><span class="p">[</span><span class="n">ivib</span><span class="p">]</span><span class="si">:</span><span class="s2">2.1e</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;       (</span><span class="si">{</span><span class="n">system_com_shift</span><span class="p">[</span><span class="n">ivib</span><span class="p">]</span><span class="si">:</span><span class="s2">2.1e</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_log_file</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">isample</span><span class="p">),</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">flog</span><span class="p">:</span>
            <span class="n">flog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        
        <span class="c1"># Iterate over number of normal mode combinations</span>
        <span class="n">vib_modes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">system_vib_modes</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="c1"># Initialize normal mode combination queue</span>
        <span class="n">sample_calculate_queue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
        
        <span class="c1"># Prepare normal mode combination jobs</span>
        <span class="n">irun</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">icomp</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nms_number_of_coupling</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>

            <span class="c1"># Prepare sign combinations</span>
            <span class="n">all_signs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span>
                <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">repeat</span><span class="o">=</span><span class="n">icomp</span><span class="p">)))</span>

            <span class="c1"># Prepare step size list</span>
            <span class="n">steps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nms_limit_of_steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">all_steps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span>
                <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="n">icomp</span><span class="p">)))</span>
            <span class="n">Nsteps</span> <span class="o">=</span> <span class="n">all_steps</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># Iterate over vib. normal mode indices and their combinations</span>
            <span class="k">for</span> <span class="n">imodes</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">vib_modes</span><span class="p">,</span> <span class="n">icomp</span><span class="p">):</span>

                <span class="c1"># Iterate over sign combinations</span>
                <span class="k">for</span> <span class="n">isign</span><span class="p">,</span> <span class="n">signs</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">all_signs</span><span class="p">):</span>
                    
                    <span class="c1"># Add mode combination job parameters</span>
                    <span class="n">sample_calculate_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">isample</span><span class="p">,</span> <span class="n">irun</span><span class="p">,</span> <span class="n">icomp</span><span class="p">,</span> <span class="n">imodes</span><span class="p">,</span> <span class="n">isign</span><span class="p">,</span> <span class="n">signs</span><span class="p">))</span>
                    <span class="n">irun</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Add stop flag</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_num_threads</span><span class="p">):</span>
            <span class="n">sample_calculate_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s1">&#39;stop&#39;</span><span class="p">)</span>
        
        <span class="c1"># Initialize continuation flag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread_keep_going</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="kc">True</span> <span class="k">for</span> <span class="n">ithread</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_num_threads</span><span class="p">)],</span>
            <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span>
            <span class="p">)</span>

        <span class="c1"># Run </span>
        <span class="n">Nsamples</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_num_threads</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_num_threads</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                
            <span class="c1"># Run job calculations</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_scan</span><span class="p">(</span>
                <span class="n">system</span><span class="p">,</span>
                <span class="n">sample_calculate_queue</span><span class="p">,</span>
                <span class="n">system_initial_results</span><span class="p">[</span><span class="s1">&#39;energy&#39;</span><span class="p">],</span>
                <span class="n">system_displfact</span><span class="p">,</span>
                <span class="n">system_modes</span><span class="p">,</span>
                <span class="n">atom_indices</span><span class="p">,</span>
                <span class="n">Nsamples</span><span class="p">)</span>
        
        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># Create threads for job calculations</span>
            <span class="n">threads</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
                    <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">run_scan</span><span class="p">,</span>
                    <span class="n">args</span><span class="o">=</span><span class="p">(</span>
                        <span class="n">system</span><span class="p">,</span>
                        <span class="n">sample_calculate_queue</span><span class="p">,</span> 
                        <span class="n">system_initial_results</span><span class="p">[</span><span class="s1">&#39;energy&#39;</span><span class="p">],</span>
                        <span class="n">system_displfact</span><span class="p">,</span>
                        <span class="n">system_modes</span><span class="p">,</span>
                        <span class="n">atom_indices</span><span class="p">,</span>
                        <span class="n">Nsamples</span><span class="p">),</span>
                    <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span>
                        <span class="s1">&#39;ithread&#39;</span><span class="p">:</span> <span class="n">ithread</span><span class="p">}</span>
                    <span class="p">)</span>
                <span class="k">for</span> <span class="n">ithread</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_num_threads</span><span class="p">)]</span>

            <span class="c1"># Start threads</span>
            <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
                <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

            <span class="c1"># Wait for threads to finish</span>
            <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
                <span class="n">thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
                
        <span class="c1"># Print sampling info</span>
        <span class="k">for</span> <span class="n">ithread</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_num_threads</span><span class="p">):</span>

            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Sampling method &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_tag</span><span class="si">:</span><span class="s2">s</span><span class="si">}</span><span class="s2">&#39; complete for &quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;system of index </span><span class="si">{</span><span class="n">index</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2"> from &#39;</span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">!&#39;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">Nsamples</span><span class="p">[</span><span class="n">ithread</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;No samples written to &quot;</span>
            <span class="k">if</span> <span class="n">Nsamples</span><span class="p">[</span><span class="n">ithread</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">Nsamples</span><span class="p">[</span><span class="n">ithread</span><span class="p">]</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2"> sample written to &quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">Nsamples</span><span class="p">[</span><span class="n">ithread</span><span class="p">]</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2"> samples written to &quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_data_file</span><span class="si">:</span><span class="s2">s</span><span class="si">}</span><span class="s2">&#39;.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;INFO:</span><span class="se">\n</span><span class="si">{</span><span class="n">msg</span><span class="si">:</span><span class="s2">s</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="NormalModeScanner.run_scan"><a class="viewcode-back" href="../../../api/asparagus.sample.html#asparagus.sample.nms.NormalModeScanner.run_scan">[docs]</a>    <span class="k">def</span> <span class="nf">run_scan</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sample_system</span><span class="p">:</span> <span class="n">ase</span><span class="o">.</span><span class="n">Atoms</span><span class="p">,</span>
        <span class="n">sample_calculate_queue</span><span class="p">:</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">,</span>
        <span class="n">system_initial_potential</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">system_displfact</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">system_modes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">atom_indices</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">Nsamples</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">ithread</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run normal mode scanning for normal mode combinations.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sample_system: ase.Atoms</span>
<span class="sd">            Initial/equilibrium sample system to apply on the normal mode</span>
<span class="sd">            combinations.</span>
<span class="sd">        sample_systems_queue: queue.Queue</span>
<span class="sd">            Queue containing normal mode combination parameters</span>
<span class="sd">        ithread: int, optional, default None</span>
<span class="sd">            Thread number</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># Initialize stored sample counter</span>
        <span class="n">Nsample</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="c1"># Get ASE calculator</span>
        <span class="n">ase_calculator</span><span class="p">,</span> <span class="n">ase_calculator_tag</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">interface</span><span class="o">.</span><span class="n">get_ase_calculator</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sample_calculator</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sample_calculator_args</span><span class="p">,</span>
                <span class="n">ithread</span><span class="o">=</span><span class="n">ithread</span><span class="p">)</span>
            <span class="p">)</span>
        
        <span class="c1"># Assign calculator</span>
        <span class="n">system</span> <span class="o">=</span> <span class="n">sample_system</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">system</span><span class="o">.</span><span class="n">set_calculator</span><span class="p">(</span><span class="n">ase_calculator</span><span class="p">)</span>

        <span class="c1"># Store equilibrium positions</span>
        <span class="n">system_initial_positions</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">get_positions</span><span class="p">()</span>
        
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_going</span><span class="p">(</span><span class="n">ithread</span><span class="p">):</span>
            
            <span class="c1"># Get sample parameters or wait</span>
            <span class="n">sample</span> <span class="o">=</span> <span class="n">sample_calculate_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

            <span class="c1"># Check for stop flag</span>
            <span class="k">if</span> <span class="n">sample</span> <span class="o">==</span> <span class="s1">&#39;stop&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">thread_keep_going</span><span class="p">[</span><span class="n">ithread</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">continue</span>
            
            <span class="c1"># Extract normal mode combination parameters</span>
            <span class="p">(</span><span class="n">isample</span><span class="p">,</span> <span class="n">irun</span><span class="p">,</span> <span class="n">icomp</span><span class="p">,</span> <span class="n">imodes</span><span class="p">,</span> <span class="n">isign</span><span class="p">,</span> <span class="n">signs</span><span class="p">)</span> <span class="o">=</span> <span class="n">sample</span>
            
            <span class="c1"># Prepare sign combinations</span>
            <span class="n">all_signs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span>
                <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">repeat</span><span class="o">=</span><span class="n">icomp</span><span class="p">)))</span>

            <span class="c1"># Prepare step size list</span>
            <span class="n">steps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nms_limit_of_steps</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">all_steps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span>
                <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">steps</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="n">icomp</span><span class="p">)))</span>
            <span class="n">Nsteps</span> <span class="o">=</span> <span class="n">all_steps</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            
            <span class="c1"># Iterate through steps</span>
            <span class="n">istep</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">while</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>

                <span class="c1"># Get current step size</span>
                <span class="n">step_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_steps</span><span class="p">[</span><span class="n">istep</span><span class="p">])</span>

                <span class="c1"># Get normal mode elongation step</span>
                <span class="n">current_step</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">signs</span><span class="p">)</span><span class="o">*</span><span class="n">step_size</span>

                <span class="c1"># Set elongation step on initial system positions</span>
                <span class="n">current_step_positions</span> <span class="o">=</span> <span class="n">system_initial_positions</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">imode</span><span class="p">,</span> <span class="n">modei</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">imodes</span><span class="p">):</span>
                    <span class="n">current_step_positions</span><span class="p">[</span><span class="n">atom_indices</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span>
                        <span class="n">system_displfact</span><span class="p">[</span><span class="n">modei</span><span class="p">]</span><span class="o">*</span><span class="n">current_step</span><span class="p">[</span><span class="n">imode</span><span class="p">]</span>
                        <span class="o">*</span> <span class="n">system_modes</span><span class="p">[</span><span class="n">modei</span><span class="p">])</span>
                <span class="n">system</span><span class="o">.</span><span class="n">set_positions</span><span class="p">(</span>
                    <span class="n">current_step_positions</span><span class="p">,</span>
                    <span class="n">apply_constraint</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

                <span class="c1"># Compute observables and check potential threshold</span>
                <span class="k">try</span><span class="p">:</span>

                    <span class="n">ase_calculator</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span>
                        <span class="n">system</span><span class="p">,</span>
                        <span class="n">properties</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_properties</span><span class="p">)</span>
                    <span class="n">current_properties</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">calc</span><span class="o">.</span><span class="n">results</span>
                    <span class="n">current_potential</span> <span class="o">=</span> <span class="n">current_properties</span><span class="p">[</span><span class="s1">&#39;energy&#39;</span><span class="p">]</span>

                    <span class="n">converged</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="k">if</span> <span class="n">current_potential</span> <span class="o">&lt;</span> <span class="n">system_initial_potential</span><span class="p">:</span>
                        <span class="n">threshold_reached</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="p">(</span>
                                <span class="n">current_potential</span> 
                                <span class="o">-</span> <span class="n">system_initial_potential</span>
                            <span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">nms_energy_limits</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">threshold_reached</span> <span class="o">=</span> <span class="p">(</span>
                            <span class="p">(</span>
                                <span class="n">current_potential</span> 
                                <span class="o">-</span> <span class="n">system_initial_potential</span>
                            <span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">nms_energy_limits</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

                <span class="k">except</span> <span class="n">ase</span><span class="o">.</span><span class="n">calculators</span><span class="o">.</span><span class="n">calculator</span><span class="o">.</span><span class="n">CalculationFailed</span><span class="p">:</span>

                    <span class="n">converged</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">threshold_reached</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="c1"># Add to dataset</span>
                <span class="k">if</span> <span class="n">converged</span><span class="p">:</span>
                    <span class="n">Nsample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_properties</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="n">Nsample</span><span class="p">)</span>

                <span class="c1"># Attach to trajectory</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_save_trajectory</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">write_trajectory</span><span class="p">(</span>
                        <span class="n">system</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_trajectory_file</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">isample</span><span class="p">))</span>

                <span class="c1"># Check energy threshold</span>
                <span class="k">if</span> <span class="n">threshold_reached</span><span class="p">:</span>

                    <span class="c1"># Check for next suitable step size index and avoid</span>
                    <span class="c1"># combination of step sizes which were already</span>
                    <span class="c1"># above the energy threshold before.</span>
                    <span class="n">istep</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">for</span> <span class="n">jstep</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">istep</span><span class="p">,</span> <span class="n">Nsteps</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">all_steps</span><span class="p">[</span><span class="n">jstep</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">step_size</span>
                        <span class="p">):</span>
                            <span class="n">istep</span> <span class="o">=</span> <span class="n">jstep</span>
                            <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">else</span><span class="p">:</span>

                    <span class="c1"># Increment step size index</span>
                    <span class="n">istep</span> <span class="o">+=</span> <span class="mi">1</span>

                <span class="c1"># Check step size progress</span>
                <span class="k">if</span> <span class="n">done</span> <span class="ow">or</span> <span class="n">istep</span> <span class="o">&gt;=</span> <span class="n">Nsteps</span><span class="p">:</span>

                    <span class="c1"># Update log file</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Vib. modes: (&quot;</span>
                    <span class="k">for</span> <span class="n">imode</span><span class="p">,</span> <span class="n">isign</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">imodes</span><span class="p">,</span> <span class="n">signs</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">isign</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;+</span><span class="si">{</span><span class="n">imode</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">, &quot;</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;-</span><span class="si">{</span><span class="n">imode</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">, &quot;</span>
                    <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;) - </span><span class="si">{</span><span class="n">istep</span><span class="si">:</span><span class="s2">4d</span><span class="si">}</span><span class="s2"> steps added</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="n">log_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_log_file</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">isample</span><span class="p">)</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">log_file</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">flog</span><span class="p">:</span>
                        <span class="n">flog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                    <span class="c1"># Set flag in case maximum Nsteps is reached</span>
                    <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="c1"># Set number of stored samples</span>
        <span class="k">if</span> <span class="n">ithread</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Nsamples</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Nsample</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Nsamples</span><span class="p">[</span><span class="n">ithread</span><span class="p">]</span> <span class="o">=</span> <span class="n">Nsample</span>

        <span class="k">return</span></div></div>


<div class="viewcode-block" id="NormalModeSampler"><a class="viewcode-back" href="../../../api/asparagus.sample.html#asparagus.sample.nms.NormalModeSampler">[docs]</a><span class="k">class</span> <span class="nc">NormalModeSampler</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">Sampler</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Normal Mode Sampling class.</span>

<span class="sd">    This is the simple version of the normal mode class as implemented in:</span>
<span class="sd">    Chem. Sci., 2017, 8, 3192-3203</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    config: (str, dict, object)</span>
<span class="sd">        Either the path to json file (str), dictionary (dict) or</span>
<span class="sd">        settings.config class object of Asparagus parameters</span>
<span class="sd">    config_file: str, optional, default see settings.default[&#39;config_file&#39;]</span>
<span class="sd">        Path to json file (str)</span>
<span class="sd">    nms_temperature: float, optional, default 300</span>
<span class="sd">        Temperature in Kelvin to sample the normal modes.</span>
<span class="sd">    nms_nsamples: int, optional, default 100</span>
<span class="sd">        Number of samples to generate.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    object</span>
<span class="sd">        Normal Mode Sampler class object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Default arguments for sample module</span>
    <span class="n">sample</span><span class="o">.</span><span class="n">Sampler</span><span class="o">.</span><span class="n">_default_args</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
        <span class="s1">&#39;nms_temperature&#39;</span><span class="p">:</span>              <span class="mf">300.0</span><span class="p">,</span>
        <span class="s1">&#39;nms_nsamples&#39;</span><span class="p">:</span>                 <span class="mi">100</span><span class="p">,</span>
        <span class="s1">&#39;nms_save_displacements&#39;</span><span class="p">:</span>       <span class="kc">False</span>
        <span class="p">})</span>
    
    <span class="c1"># Expected data types of input variables</span>
    <span class="n">sample</span><span class="o">.</span><span class="n">Sampler</span><span class="o">.</span><span class="n">_dtypes_args</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
        <span class="s1">&#39;nms_temperature&#39;</span><span class="p">:</span>              <span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">is_numeric</span><span class="p">],</span>
        <span class="s1">&#39;nms_nsamples&#39;</span><span class="p">:</span>                 <span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">is_integer</span><span class="p">],</span>
        <span class="s1">&#39;nms_save_displacements&#39;</span><span class="p">:</span>       <span class="p">[</span><span class="n">utils</span><span class="o">.</span><span class="n">is_bool</span><span class="p">],</span>
        <span class="p">})</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="nb">object</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">config_file</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
        <span class="n">nms_temperature</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">nms_nsamples</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">nms_save_displacements</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>

        <span class="c1"># Sampler class label</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sample_tag</span> <span class="o">=</span> <span class="s1">&#39;nmsmpl&#39;</span>

        <span class="c1"># Initialize parent class</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">sample_tag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_tag</span><span class="p">,</span>
            <span class="n">config</span><span class="o">=</span><span class="n">config</span><span class="p">,</span>
            <span class="n">config_file</span><span class="o">=</span><span class="n">config_file</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>

        <span class="c1">#################################</span>
        <span class="c1"># # # Check NMS Class Input # # #</span>
        <span class="c1">#################################</span>

        <span class="c1"># Get configuration object</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get_config</span><span class="p">(</span>
            <span class="n">config</span><span class="p">,</span> <span class="n">config_file</span><span class="p">,</span> <span class="n">config_from</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        
        <span class="c1"># Check input parameter, set default values if necessary and</span>
        <span class="c1"># update the configuration dictionary</span>
        <span class="n">config_update</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
            <span class="n">instance</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">argitems</span><span class="o">=</span><span class="n">utils</span><span class="o">.</span><span class="n">get_input_args</span><span class="p">(),</span>
            <span class="n">check_default</span><span class="o">=</span><span class="n">utils</span><span class="o">.</span><span class="n">get_default_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample</span><span class="p">),</span>
            <span class="n">check_dtype</span><span class="o">=</span><span class="n">utils</span><span class="o">.</span><span class="n">get_dtype_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sample</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Check sample properties for energy and forces property which is </span>
        <span class="c1"># required for normal mode scanning</span>
        <span class="k">if</span> <span class="s1">&#39;energy&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_properties</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sample_properties</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;energy&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;forces&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_properties</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sample_properties</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;forces&#39;</span><span class="p">)</span>

        <span class="k">return</span>

<div class="viewcode-block" id="NormalModeSampler.get_info"><a class="viewcode-back" href="../../../api/asparagus.sample.html#asparagus.sample.nms.NormalModeSampler.get_info">[docs]</a>    <span class="k">def</span> <span class="nf">get_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Obtain information about the Normal Mode Sampling class object.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            Dictionary with information about the Normal Mode Sampling class</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">info</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">get_info</span><span class="p">()</span>
        <span class="n">info</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
            <span class="s1">&#39;nms_temperature&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nms_temperature</span><span class="p">,</span>
            <span class="s1">&#39;nms_nsamples&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nms_nsamples</span><span class="p">,</span>
            <span class="s1">&#39;nms_save_displacements&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">nms_save_displacements</span><span class="p">,</span>
            <span class="p">})</span>
        
        <span class="k">return</span> <span class="n">info</span></div>

<div class="viewcode-block" id="NormalModeSampler.run_systems"><a class="viewcode-back" href="../../../api/asparagus.sample.html#asparagus.sample.nms.NormalModeSampler.run_systems">[docs]</a>    <span class="k">def</span> <span class="nf">run_systems</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sample_systems_queue</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">nms_indices</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">nms_clean</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform Normal Mode Scanning on the sample system.</span>
<span class="sd">        Iterate over systems using &#39;sample_num_threads&#39; threads.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sample_systems_queue: queue.Queue, optional, default None</span>
<span class="sd">            Queue object including sample systems or where &#39;sample_systems&#39; </span>
<span class="sd">            input will be added. If not defined, an empty queue will be </span>
<span class="sd">            assigned.</span>
<span class="sd">        nms_indices: list[int], optional, default None</span>
<span class="sd">            List of atom indices to include in normal mode analysis.</span>
<span class="sd">            If none, indices if a full list of atom indices with length ot the</span>
<span class="sd">            atom number of the system.</span>
<span class="sd">            Atom indices from atoms constraint by FixAtoms are removed from</span>
<span class="sd">            index list and the normal mode analysis.</span>
<span class="sd">        nms_clean: bool, optional, default True</span>
<span class="sd">            If True, checkpoint files for atom displacement calculations</span>
<span class="sd">            in {sample_directory}/vib_{isample} will be deleted.</span>
<span class="sd">            Else, results from available  checkpoint files will be used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># Optimize sample systems or take as normal mode analysis input</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_systems_optimize</span><span class="p">:</span>
            
            <span class="c1"># Add stop flag</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_num_threads</span><span class="p">):</span>
                <span class="n">sample_systems_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s1">&#39;stop&#39;</span><span class="p">)</span>
            
            <span class="c1"># Initialize continuation flag</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thread_keep_going</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span><span class="kc">True</span> <span class="k">for</span> <span class="n">ithread</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_num_threads</span><span class="p">)],</span>
                <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span>
                <span class="p">)</span>
            
            <span class="c1"># Initialize optimized sample system into queue</span>
            <span class="n">sample_input_queue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_num_threads</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>

                <span class="c1"># Run sample system optimization</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">run_optimization</span><span class="p">(</span>
                    <span class="n">sample_systems_queue</span><span class="o">=</span><span class="n">sample_systems_queue</span><span class="p">,</span>
                    <span class="n">sample_optimzed_queue</span><span class="o">=</span><span class="n">sample_input_queue</span><span class="p">)</span>
            
            <span class="k">else</span><span class="p">:</span>

                <span class="c1"># Create threads for sample system optimization</span>
                <span class="n">threads</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
                        <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">run_optimization</span><span class="p">,</span>
                        <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span>
                            <span class="s1">&#39;sample_systems_queue&#39;</span><span class="p">:</span> <span class="n">sample_systems_queue</span><span class="p">,</span>
                            <span class="s1">&#39;sample_optimzed_queue&#39;</span><span class="p">:</span> <span class="n">sample_input_queue</span><span class="p">,</span>
                            <span class="s1">&#39;ithread&#39;</span><span class="p">:</span> <span class="n">ithread</span><span class="p">}</span>
                        <span class="p">)</span>
                    <span class="k">for</span> <span class="n">ithread</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_num_threads</span><span class="p">)]</span>

                <span class="c1"># Start threads</span>
                <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
                    <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

                <span class="c1"># Wait for threads to finish</span>
                <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
                    <span class="n">thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            
            <span class="c1"># Set sample system queue as optimized sample system queue</span>
            <span class="n">sample_input_queue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_systems_queue</span>

        <span class="c1"># Run normal mode sampling</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">sample_input_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_system</span><span class="p">(</span>
                <span class="n">sample_input_queue</span><span class="p">,</span>
                <span class="n">nms_indices</span><span class="p">,</span>
                <span class="n">nms_clean</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        
        <span class="k">return</span></div>

<div class="viewcode-block" id="NormalModeSampler.run_system"><a class="viewcode-back" href="../../../api/asparagus.sample.html#asparagus.sample.nms.NormalModeSampler.run_system">[docs]</a>    <span class="k">def</span> <span class="nf">run_system</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sample_systems_queue</span><span class="p">:</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">,</span>
        <span class="n">nms_indices</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">nms_clean</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform Normal Mode Sampling on the sample system.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sample_systems_queue: queue.Queue</span>
<span class="sd">            Queue object including sample systems.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Initialize stored sample counter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Nsample</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># Initialize normal mode analysis queue</span>
        <span class="n">sample_calculate_queue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>

        <span class="c1"># Get sample system for normal mode analysis</span>
        <span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="n">isample</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span> <span class="o">=</span> <span class="n">sample_systems_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

        <span class="c1"># Print sampler info</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;INFO:</span><span class="se">\n</span><span class="s2">Start normal mode sampling of the system &quot;</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;from &#39;</span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">&#39; of index </span><span class="si">{</span><span class="n">index</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        
        <span class="c1"># Get non-fixed atoms indices</span>
        <span class="k">if</span> <span class="n">nms_indices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">atom_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
                <span class="n">system</span><span class="o">.</span><span class="n">get_global_number_of_atoms</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">atom_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">nms_indices</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">constraint</span> <span class="ow">in</span> <span class="n">system</span><span class="o">.</span><span class="n">constraints</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">constraint</span><span class="p">,</span> <span class="n">FixAtoms</span><span class="p">):</span>
                <span class="n">atom_indices</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">idx</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">atom_indices</span>
                    <span class="k">if</span> <span class="n">idx</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">constraint</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
        <span class="n">atom_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">atom_indices</span><span class="p">)</span>
        
        <span class="c1"># Prepare system parameter</span>
        <span class="n">Natoms</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">atom_indices</span><span class="p">)</span>
        <span class="n">Nmodes</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">Natoms</span>

        <span class="c1"># Initialize Vibration class</span>
        <span class="n">system_vibrations</span> <span class="o">=</span> <span class="n">Vibrations_Asparagus</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">system</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sample_calculator</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sample_calculator_args</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nms_save_displacements</span><span class="p">,</span>
            <span class="n">indices</span><span class="o">=</span><span class="n">atom_indices</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_directory</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;vib_</span><span class="si">{</span><span class="n">isample</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
            <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">nms_clean</span><span class="p">:</span>
            <span class="n">system_vibrations</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>
        
        <span class="c1"># Add jobs to calculation queue</span>
        <span class="n">system_vibrations</span><span class="o">.</span><span class="n">add_calculations</span><span class="p">(</span>
            <span class="n">sample_calculate_queue</span><span class="p">)</span>

        <span class="c1"># Add stop flag</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_num_threads</span><span class="p">):</span>
            <span class="n">sample_calculate_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s1">&#39;stop&#39;</span><span class="p">)</span>
        
        <span class="c1"># Initialize continuation flag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread_keep_going</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="kc">True</span> <span class="k">for</span> <span class="n">ithread</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_num_threads</span><span class="p">)],</span>
            <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_num_threads</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            
            <span class="c1"># Run job calculations</span>
            <span class="n">system_vibrations</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                <span class="n">sample_calculate_queue</span><span class="p">,</span>
                <span class="n">sample_calculator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_calculator</span><span class="p">,</span>
                <span class="n">sample_calculator_args</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_calculator_args</span><span class="p">)</span>
        
        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># Create threads for job calculations</span>
            <span class="n">threads</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
                    <span class="n">target</span><span class="o">=</span><span class="n">system_vibrations</span><span class="o">.</span><span class="n">run</span><span class="p">,</span>
                    <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">sample_calculate_queue</span><span class="p">,</span> <span class="p">),</span>
                    <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span>
                        <span class="s1">&#39;sample_calculator&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_calculator</span><span class="p">,</span>
                        <span class="s1">&#39;sample_calculator_args&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_calculator_args</span><span class="p">,</span>
                        <span class="s1">&#39;ithread&#39;</span><span class="p">:</span> <span class="n">ithread</span><span class="p">}</span>
                    <span class="p">)</span>
                <span class="k">for</span> <span class="n">ithread</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_num_threads</span><span class="p">)]</span>

            <span class="c1"># Start threads</span>
            <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
                <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

            <span class="c1"># Wait for threads to finish</span>
            <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
                <span class="n">thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

        <span class="c1"># Print sampler info</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;INFO:</span><span class="se">\n</span><span class="s2">Normal mode analysis calculation completed for &quot;</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;the system from &#39;</span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">&#39; of index </span><span class="si">{</span><span class="n">index</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        
        <span class="c1"># Finish normal mode analysis and diagonalize Hessian matrix</span>
        <span class="n">system_vibrations</span><span class="o">.</span><span class="n">summary</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        
        <span class="c1"># Get initial (equilibrium) energy of the sampling system</span>
        <span class="n">system_initial_results</span> <span class="o">=</span> <span class="n">system_vibrations</span><span class="o">.</span><span class="n">get_initial_results</span><span class="p">()</span>
        
        <span class="c1"># Store equilibrium positions</span>
        <span class="n">system_initial_positions</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">get_positions</span><span class="p">()</span>

        <span class="c1"># (Trans. + Rot. + ) Vibrational frequencies in cm**-1</span>
        <span class="n">system_frequencies</span> <span class="o">=</span> <span class="n">system_vibrations</span><span class="o">.</span><span class="n">get_frequencies</span><span class="p">()</span>

        <span class="c1"># (Trans. + Rot. + ) Vibrational modes normalized to 1</span>
        <span class="n">system_modes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="n">system_vibrations</span><span class="o">.</span><span class="n">get_mode</span><span class="p">(</span><span class="n">imode</span><span class="p">)[</span><span class="n">atom_indices</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">Natoms</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
            <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="n">system_vibrations</span><span class="o">.</span><span class="n">get_mode</span><span class="p">(</span><span class="n">imode</span><span class="p">)[</span><span class="n">atom_indices</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                    <span class="n">Natoms</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">imode</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nmodes</span><span class="p">)])</span>

        <span class="c1"># Reduced mass per mode (in amu)</span>
        <span class="n">system_redmass</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
            <span class="mf">1.</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="n">system_modes</span><span class="p">[</span><span class="n">imode</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
                <span class="o">/</span> <span class="n">system</span><span class="o">.</span><span class="n">get_masses</span><span class="p">()[</span><span class="n">atom_indices</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">Natoms</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">imode</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Nmodes</span><span class="p">)])</span>

        <span class="c1"># Force constant per mode (in eV/Angstrom**2)</span>
        <span class="n">system_forceconst</span> <span class="o">=</span> <span class="p">(</span>
            <span class="mf">4.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">system_frequencies</span><span class="p">)</span><span class="o">*</span><span class="mf">1.e2</span><span class="o">*</span><span class="n">units</span><span class="o">.</span><span class="n">_c</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
            <span class="o">*</span> <span class="n">system_redmass</span><span class="o">*</span><span class="n">units</span><span class="o">.</span><span class="n">_amu</span><span class="o">*</span><span class="n">units</span><span class="o">.</span><span class="n">J</span><span class="o">*</span><span class="mf">1.e-20</span><span class="p">)</span>

        <span class="c1"># Add normal mode analysis results to log file</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Start Normal Mode Sampling at system: &quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_data_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">system</span><span class="o">.</span><span class="n">get_chemical_formula</span><span class="p">()</span><span class="si">:</span><span class="s2">s</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_data_file</span><span class="si">:</span><span class="s2">s</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot; Index | Frequency (cm**-1) </span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">msg</span> <span class="o">+=</span> <span class="s2">&quot;----------------------------</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">for</span> <span class="n">ivib</span><span class="p">,</span> <span class="n">freq</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">system_frequencies</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; </span><span class="si">{</span><span class="n">ivib</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">:</span><span class="s2">5d</span><span class="si">}</span><span class="s2"> | </span><span class="si">{</span><span class="n">freq</span><span class="si">:</span><span class="s2">18.2f</span><span class="si">}</span><span class="s2"> |</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_log_file</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">isample</span><span class="p">),</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">flog</span><span class="p">:</span>
            <span class="n">flog</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># Initialize normal mode sampling queue</span>
        <span class="n">sample_calculate_queue</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
        
        <span class="c1"># Initialize continuation flag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thread_keep_going</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span><span class="kc">True</span> <span class="k">for</span> <span class="n">ithread</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_num_threads</span><span class="p">)],</span>
            <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span>
            <span class="p">)</span>

        <span class="c1"># Start calculation run</span>
        <span class="n">Nsamples</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_num_threads</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_num_threads</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            
            <span class="c1"># Add calculation jobs</span>
            <span class="k">for</span> <span class="n">irun</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nms_nsamples</span><span class="p">):</span>
                <span class="n">sample_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sample_positions</span><span class="p">(</span>
                    <span class="n">system_initial_positions</span><span class="p">,</span>
                    <span class="n">Nmodes</span><span class="p">,</span> 
                    <span class="n">system_modes</span><span class="p">,</span> 
                    <span class="n">system_redmass</span><span class="p">,</span> 
                    <span class="n">system_forceconst</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nms_temperature</span><span class="p">)</span>
                <span class="n">sample_calculate_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">isample</span><span class="p">,</span> <span class="n">irun</span><span class="p">,</span> <span class="n">sample_position</span><span class="p">))</span>
            
            <span class="c1"># Add stop flag</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_num_threads</span><span class="p">):</span>
                <span class="n">sample_calculate_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s1">&#39;stop&#39;</span><span class="p">)</span>
                
            <span class="c1"># Run job calculations</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">run_sampling</span><span class="p">(</span>
                <span class="n">system</span><span class="p">,</span>
                <span class="n">sample_calculate_queue</span><span class="p">,</span>
                <span class="n">Nsamples</span><span class="p">)</span>
        
        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># Create threads for job calculations</span>
            <span class="n">threads</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
                    <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">run_sampling</span><span class="p">,</span>
                    <span class="n">args</span><span class="o">=</span><span class="p">(</span>
                        <span class="n">system</span><span class="p">,</span>
                        <span class="n">sample_calculate_queue</span><span class="p">,</span>
                        <span class="n">Nsamples</span><span class="p">),</span>
                    <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span>
                        <span class="s1">&#39;ithread&#39;</span><span class="p">:</span> <span class="n">ithread</span><span class="p">}</span>
                    <span class="p">)</span>
                <span class="k">for</span> <span class="n">ithread</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_num_threads</span><span class="p">)]</span>

            <span class="c1"># Start threads</span>
            <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
                <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

            <span class="c1"># Add calculation jobs</span>
            <span class="k">for</span> <span class="n">irun</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nms_nsamples</span><span class="p">):</span>
                <span class="n">sample_position</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sample_positions</span><span class="p">(</span>
                    <span class="n">system_initial_positions</span><span class="p">,</span>
                    <span class="n">Nmodes</span><span class="p">,</span> 
                    <span class="n">system_modes</span><span class="p">,</span> 
                    <span class="n">system_redmass</span><span class="p">,</span> 
                    <span class="n">system_forceconst</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nms_temperature</span><span class="p">)</span>
                <span class="n">sample_calculate_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">isample</span><span class="p">,</span> <span class="n">irun</span><span class="p">,</span> <span class="n">sample_position</span><span class="p">))</span>
            
            <span class="c1"># Add stop flag</span>
            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_num_threads</span><span class="p">):</span>
                <span class="n">sample_calculate_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="s1">&#39;stop&#39;</span><span class="p">)</span>

            <span class="c1"># Wait for threads to finish</span>
            <span class="k">for</span> <span class="n">thread</span> <span class="ow">in</span> <span class="n">threads</span><span class="p">:</span>
                <span class="n">thread</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

        <span class="c1"># Print sampling info</span>
        <span class="k">for</span> <span class="n">ithread</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_num_threads</span><span class="p">):</span>

            <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Sampling method &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_tag</span><span class="si">:</span><span class="s2">s</span><span class="si">}</span><span class="s2">&#39; complete for &quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;system of index </span><span class="si">{</span><span class="n">index</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2"> from &#39;</span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">!&#39;</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="k">if</span> <span class="n">Nsamples</span><span class="p">[</span><span class="n">ithread</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;No samples written to &quot;</span>
            <span class="k">if</span> <span class="n">Nsamples</span><span class="p">[</span><span class="n">ithread</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">Nsamples</span><span class="p">[</span><span class="n">ithread</span><span class="p">]</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2"> sample written to &quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">Nsamples</span><span class="p">[</span><span class="n">ithread</span><span class="p">]</span><span class="si">:</span><span class="s2">d</span><span class="si">}</span><span class="s2"> samples written to &quot;</span>
            <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_data_file</span><span class="si">:</span><span class="s2">s</span><span class="si">}</span><span class="s2">&#39;.</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;INFO:</span><span class="se">\n</span><span class="si">{</span><span class="n">msg</span><span class="si">:</span><span class="s2">s</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="NormalModeSampler.run_sampling"><a class="viewcode-back" href="../../../api/asparagus.sample.html#asparagus.sample.nms.NormalModeSampler.run_sampling">[docs]</a>    <span class="k">def</span> <span class="nf">run_sampling</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sample_system</span><span class="p">:</span> <span class="n">ase</span><span class="o">.</span><span class="n">Atoms</span><span class="p">,</span>
        <span class="n">sample_calculate_queue</span><span class="p">:</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">,</span>
        <span class="n">Nsamples</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">ithread</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run normal mode scanning for normal mode combinations.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sample_system: ase.Atoms</span>
<span class="sd">            Initial/equilibrium sample system to apply on the normal mode</span>
<span class="sd">            combinations.</span>
<span class="sd">        sample_systems_queue: queue.Queue</span>
<span class="sd">            Queue containing normal mode combination parameters</span>
<span class="sd">        ithread: int, optional, default None</span>
<span class="sd">            Thread number</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Initialize stored sample counter</span>
        <span class="n">Nsample</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="c1"># Get ASE calculator</span>
        <span class="n">ase_calculator</span><span class="p">,</span> <span class="n">ase_calculator_tag</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">interface</span><span class="o">.</span><span class="n">get_ase_calculator</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sample_calculator</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sample_calculator_args</span><span class="p">,</span>
                <span class="n">ithread</span><span class="o">=</span><span class="n">ithread</span><span class="p">)</span>
            <span class="p">)</span>
        
        <span class="c1"># Assign calculator</span>
        <span class="n">system</span> <span class="o">=</span> <span class="n">sample_system</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">system</span><span class="o">.</span><span class="n">set_calculator</span><span class="p">(</span><span class="n">ase_calculator</span><span class="p">)</span>

        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_going</span><span class="p">(</span><span class="n">ithread</span><span class="p">):</span>
            
            <span class="c1"># Get sample parameters or wait</span>
            <span class="n">sample</span> <span class="o">=</span> <span class="n">sample_calculate_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

            <span class="c1"># Check for stop flag</span>
            <span class="k">if</span> <span class="n">sample</span> <span class="o">==</span> <span class="s1">&#39;stop&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">thread_keep_going</span><span class="p">[</span><span class="n">ithread</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">continue</span>
            
            <span class="c1"># Extract normal mode combination parameters</span>
            <span class="p">(</span><span class="n">isample</span><span class="p">,</span> <span class="n">irun</span><span class="p">,</span> <span class="n">sample_positions</span><span class="p">)</span> <span class="o">=</span> <span class="n">sample</span>
            
            <span class="c1"># Set sample positions to calculate</span>
            <span class="n">system</span><span class="o">.</span><span class="n">set_positions</span><span class="p">(</span><span class="n">sample_positions</span><span class="p">)</span>
            
            <span class="c1"># Compute observables and check potential threshold</span>
            <span class="k">try</span><span class="p">:</span>

                <span class="n">ase_calculator</span><span class="o">.</span><span class="n">calculate</span><span class="p">(</span>
                    <span class="n">system</span><span class="p">,</span>
                    <span class="n">properties</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_properties</span><span class="p">)</span>
                <span class="n">converged</span> <span class="o">=</span> <span class="kc">True</span>
            
            <span class="k">except</span> <span class="n">ase</span><span class="o">.</span><span class="n">calculators</span><span class="o">.</span><span class="n">calculator</span><span class="o">.</span><span class="n">CalculationFailed</span><span class="p">:</span>

                <span class="n">converged</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># Add to dataset</span>
            <span class="k">if</span> <span class="n">converged</span><span class="p">:</span>
                <span class="n">Nsample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_properties</span><span class="p">(</span><span class="n">system</span><span class="p">,</span> <span class="n">Nsample</span><span class="p">)</span>

            <span class="c1"># Attach to trajectory</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_save_trajectory</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write_trajectory</span><span class="p">(</span>
                    <span class="n">system</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_trajectory_file</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">isample</span><span class="p">))</span>

        <span class="c1"># Set number of stored samples</span>
        <span class="k">if</span> <span class="n">ithread</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Nsamples</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Nsample</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Nsamples</span><span class="p">[</span><span class="n">ithread</span><span class="p">]</span> <span class="o">=</span> <span class="n">Nsample</span>

        <span class="k">return</span></div>
        
<div class="viewcode-block" id="NormalModeSampler.get_sample_positions"><a class="viewcode-back" href="../../../api/asparagus.sample.html#asparagus.sample.nms.NormalModeSampler.get_sample_positions">[docs]</a>    <span class="k">def</span> <span class="nf">get_sample_positions</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">initial_positions</span><span class="p">,</span> 
        <span class="n">Nmodes</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">vib_modes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">vib_masses</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> 
        <span class="n">vib_fcnts</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> 
        <span class="n">vib_temp</span><span class="p">:</span> <span class="nb">float</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create the new coordinates for the system.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        initial_positions: np.ndarray(float)</span>
<span class="sd">            Sample system position to add normal mode displacement</span>
<span class="sd">        Nmodes: int</span>
<span class="sd">            Normal modes of the system</span>
<span class="sd">        vib_modes: np.ndarray(float)</span>
<span class="sd">            Nomralized vibrational modes</span>
<span class="sd">        vib_masses: np.ndarray(float)</span>
<span class="sd">            Reduced mass of the normal modes</span>
<span class="sd">        vib_fcnts: np.ndarray(float)</span>
<span class="sd">            Force constant per normal mode (in eV/Angstrom**2)</span>
<span class="sd">        vib_temp: float</span>
<span class="sd">            Temperature in Kelvin to sample the normal modes.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            Sample coordinates for the system</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">Rx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">(</span><span class="n">Nmodes</span><span class="p">,</span> <span class="n">vib_fcnts</span><span class="p">,</span> <span class="n">vib_temp</span><span class="p">)</span>
        <span class="n">sample_positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">initial_positions</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">imode</span><span class="p">,</span> <span class="n">mode_i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">vib_modes</span><span class="p">):</span>
            <span class="n">disp_i</span> <span class="o">=</span> <span class="n">vib_masses</span><span class="p">[</span><span class="n">imode</span><span class="p">]</span><span class="o">*</span><span class="n">Rx</span><span class="p">[</span><span class="n">imode</span><span class="p">]</span><span class="o">*</span><span class="n">mode_i</span>
            <span class="n">sample_positions</span> <span class="o">+=</span> <span class="n">disp_i</span>

        <span class="k">return</span> <span class="n">sample_positions</span></div>

<div class="viewcode-block" id="NormalModeSampler.R"><a class="viewcode-back" href="../../../api/asparagus.sample.html#asparagus.sample.nms.NormalModeSampler.R">[docs]</a>    <span class="k">def</span> <span class="nf">R</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Nmodes</span><span class="p">,</span> <span class="n">fcnts</span><span class="p">,</span> <span class="n">temp</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Made a random displacement for each of the modes in the system.</span>
<span class="sd">        The displacements follow a Bernoulli distribution with $P=0.5$</span>

<span class="sd">        The value R is given by:</span>
<span class="sd">        .. :math:</span>

<span class="sd">            R_{i} = \pm \sqrt{\dfrac{3c_{i}N_{a}k_{b}T}{K_{i}}}</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Nmodes: int</span>
<span class="sd">            Number of modes in the system</span>
<span class="sd">        fcnts: np.ndarray(float)</span>
<span class="sd">            Force constant per mode (in eV/Angstrom**2)</span>
<span class="sd">        temp: float</span>
<span class="sd">            Temperature in Kelvin to sample the normal modes.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.ndarray</span>
<span class="sd">            Array of displacements for each mode in the system</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">random_num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">Nmodes</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">sign</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mf">0.5</span> <span class="k">else</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">random_num</span><span class="p">]</span>
        <span class="n">fix_fcnts</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.05</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mf">0.05</span> <span class="k">else</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">fcnts</span><span class="p">]</span>
        <span class="n">R</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fix_fcnts</span><span class="p">):</span>
            <span class="n">R_i</span> <span class="o">=</span> <span class="n">sign</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="mi">3</span><span class="o">*</span><span class="n">random_num</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">units</span><span class="o">.</span><span class="n">kB</span><span class="o">*</span><span class="n">temp</span><span class="p">)</span><span class="o">/</span><span class="n">j</span><span class="p">)</span>
            <span class="n">R</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">R_i</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">R</span><span class="p">)</span></div></div>


<span class="k">class</span> <span class="nc">Vibrations_Asparagus</span><span class="p">(</span><span class="n">Vibrations_ASE</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate vibrational modes using finite difference or calculated Hessian </span>
<span class="sd">    directly.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sampler</span><span class="p">,</span>
        <span class="n">sample_atoms</span><span class="p">,</span>
        <span class="n">sample_calculator</span><span class="p">,</span>
        <span class="n">sample_calculator_args</span><span class="p">,</span>
        <span class="n">nms_save_displacements</span><span class="p">,</span>
        <span class="n">indices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
        <span class="n">name</span><span class="o">=</span><span class="s1">&#39;vib&#39;</span><span class="p">,</span>
        <span class="n">delta</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> 
        <span class="n">nfree</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
        
        <span class="c1"># Assign calculator to atoms object</span>
        <span class="n">sample_atoms</span> <span class="o">=</span> <span class="n">sampler</span><span class="o">.</span><span class="n">assign_calculator</span><span class="p">(</span>
            <span class="n">sample_atoms</span><span class="p">,</span>
            <span class="n">sample_calculator</span><span class="o">=</span><span class="n">sample_calculator</span><span class="p">,</span>
            <span class="n">sample_calculator_args</span><span class="o">=</span><span class="n">sample_calculator_args</span><span class="p">)</span>
        
        <span class="c1"># Initialize ASE Vibrations parent class</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">sample_atoms</span><span class="p">,</span> 
            <span class="n">indices</span><span class="o">=</span><span class="n">indices</span><span class="p">,</span> 
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> 
            <span class="n">delta</span><span class="o">=</span><span class="n">delta</span><span class="p">,</span> 
            <span class="n">nfree</span><span class="o">=</span><span class="n">nfree</span>
            <span class="p">)</span>
        
        <span class="c1"># Check for Hessian in calculator implemented properties</span>
        <span class="k">if</span> <span class="s1">&#39;hessian&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc</span><span class="o">.</span><span class="n">implemented_properties</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hessian_avail</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hessian_avail</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="c1"># Assign class parameter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sampler</span> <span class="o">=</span> <span class="n">sampler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nms_save_displacements</span> <span class="o">=</span> <span class="n">nms_save_displacements</span>

        <span class="c1"># Initialize equilibrium/initial sample system result dictionary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eq_results</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">add_calculations</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">calculate_queue</span><span class="p">:</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add vibration calculations to job queue.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        calculate_queue : queue.Queue</span>
<span class="sd">            Sample system queue</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># Check for writing rights and old result files</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">writable</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot run calculation. &quot;</span>
                <span class="o">+</span> <span class="s2">&quot;Cache must be removed or split in order &quot;</span>
                <span class="o">+</span> <span class="s2">&quot;to have only one sort of data structure at a time.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_old_pickles</span><span class="p">()</span>
        
        <span class="c1"># Add jobs to compute Hessian or forces at atom displacements to the</span>
        <span class="c1"># job queue</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hessian_avail</span><span class="p">:</span>
            
            <span class="n">displacements</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">displacements</span><span class="p">()</span>
            <span class="n">eq_disp</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">displacements</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">eq_disp</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;eq&#39;</span>
            <span class="n">calculate_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="p">,</span> <span class="n">eq_disp</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
            
        <span class="k">else</span><span class="p">:</span>
            
            <span class="k">for</span> <span class="n">disp</span><span class="p">,</span> <span class="n">atoms</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterdisplace</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                <span class="n">calculate_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">disp</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                
        <span class="k">return</span> <span class="n">calculate_queue</span>
    
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">calculate_queue</span><span class="p">:</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">,</span>
        <span class="n">sample_calculator</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">sample_calculator_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ithread</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the vibration calculations.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        calculate_queue : queue.Queue</span>
<span class="sd">            Sample system queue</span>
<span class="sd">        sample_calculator : (str, object), optional, default None</span>
<span class="sd">            ASE calculator object or string of an ASE calculator class</span>
<span class="sd">            name to assign to the sample systems</span>
<span class="sd">        sample_calculator_args : dict, optional, default None</span>
<span class="sd">            Dictionary of keyword arguments to initialize the ASE</span>
<span class="sd">            calculator</span>
<span class="sd">        ithread: int, optional, default None</span>
<span class="sd">            Thread number</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Get ASE calculator</span>
        <span class="n">ase_calculator</span><span class="p">,</span> <span class="n">ase_calculator_tag</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">interface</span><span class="o">.</span><span class="n">get_ase_calculator</span><span class="p">(</span>
                <span class="n">sample_calculator</span><span class="p">,</span>
                <span class="n">sample_calculator_args</span><span class="p">,</span>
                <span class="n">ithread</span><span class="o">=</span><span class="n">ithread</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampler</span><span class="o">.</span><span class="n">keep_going</span><span class="p">(</span><span class="n">ithread</span><span class="p">):</span>
        
            <span class="c1"># Get job parameters or wait</span>
            <span class="n">sample</span> <span class="o">=</span> <span class="n">calculate_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

            <span class="c1"># Check for stop flag</span>
            <span class="k">if</span> <span class="n">sample</span> <span class="o">==</span> <span class="s1">&#39;stop&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sampler</span><span class="o">.</span><span class="n">thread_keep_going</span><span class="p">[</span><span class="n">ithread</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">continue</span>

            <span class="c1"># Get job to run</span>
            <span class="p">(</span><span class="n">atoms</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="o">=</span> <span class="n">sample</span>
            
            <span class="c1"># Assign calculator</span>
            <span class="n">atoms</span><span class="o">.</span><span class="n">set_calculator</span><span class="p">(</span><span class="n">ase_calculator</span><span class="p">)</span>

            <span class="c1"># Run job</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">lock</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>

                <span class="c1"># Read results if result file exist</span>
                <span class="k">if</span> <span class="n">handle</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

                    <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                    <span class="n">atoms</span><span class="o">.</span><span class="n">calc</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="n">results</span>

                <span class="c1"># Or run calculation</span>
                <span class="k">else</span><span class="p">:</span>

                    <span class="c1"># Compute essential results</span>
                    <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hessian_avail</span><span class="p">:</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;hessian&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">get_hessian</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">results</span><span class="p">[</span><span class="s1">&#39;forces&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atoms</span><span class="o">.</span><span class="n">get_forces</span><span class="p">()</span>
                    
                    <span class="c1"># Add additional results</span>
                    <span class="k">for</span> <span class="n">prop</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">ase_calculator</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">results</span><span class="p">[</span><span class="n">prop</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>

                    <span class="k">if</span> <span class="n">world</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">handle</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>

            <span class="c1"># Store results for equilibrium/initial sample system</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;eq&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">eq_results</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">atoms_properties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampler</span><span class="o">.</span><span class="n">get_properties</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sampler</span><span class="o">.</span><span class="n">sample_dataset</span><span class="o">.</span><span class="n">add_atoms</span><span class="p">(</span>
                    <span class="n">atoms</span><span class="p">,</span> <span class="n">atoms_properties</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Store results of for atom displacement calculations if</span>
                <span class="c1"># requested</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nms_save_displacements</span><span class="p">:</span>
                    <span class="n">atoms_properties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampler</span><span class="o">.</span><span class="n">get_properties</span><span class="p">(</span><span class="n">atoms</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">sampler</span><span class="o">.</span><span class="n">sample_dataset</span><span class="o">.</span><span class="n">add_atoms</span><span class="p">(</span>
                        <span class="n">atoms</span><span class="p">,</span> <span class="n">atoms_properties</span><span class="p">)</span>

        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">get_initial_results</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Return equilibrium/initial sample system results</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">eq_results</span>

    <span class="k">def</span> <span class="nf">summary</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">method</span><span class="o">=</span><span class="s1">&#39;standard&#39;</span><span class="p">,</span>
        <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;central&#39;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run modified summary function with respect to the ASE version.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">energies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_energies</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="n">direction</span><span class="p">)</span>
        <span class="n">summary_lines</span> <span class="o">=</span> <span class="n">VibrationsData</span><span class="o">.</span><span class="n">_tabulate_from_energies</span><span class="p">(</span><span class="n">energies</span><span class="p">)</span>
        <span class="n">log_text</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">summary_lines</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
        
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;INFO:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">log_text</span><span class="p">)</span>
        
        <span class="k">return</span>
        
    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">method</span><span class="o">=</span><span class="s1">&#39;standard&#39;</span><span class="p">,</span> 
        <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;central&#39;</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Read calculation results, get Hessian and solve eigenvalue problem.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">=</span> <span class="n">method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">direction</span> <span class="o">=</span> <span class="n">direction</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;standard&#39;</span><span class="p">,</span> <span class="s1">&#39;frederiksen&#39;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;central&#39;</span><span class="p">,</span> <span class="s1">&#39;forward&#39;</span><span class="p">,</span> <span class="s1">&#39;backward&#39;</span><span class="p">]</span>

        <span class="c1"># Initialize Hesse matrix</span>
        <span class="n">n</span> <span class="o">=</span> <span class="mi">3</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">)</span>
        <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
        
        <span class="n">eq_disp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_eq_disp</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hessian_avail</span><span class="p">:</span>
            
            <span class="n">Hfull</span> <span class="o">=</span> <span class="n">eq_disp</span><span class="o">.</span><span class="n">vib</span><span class="o">.</span><span class="n">_cached</span><span class="p">[</span><span class="s1">&#39;hessian&#39;</span><span class="p">]</span>
            <span class="n">selection</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ii</span><span class="p">,</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">):</span>
                <span class="n">selection</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">ii</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">index</span> <span class="o">+</span> <span class="mi">0</span>
                <span class="n">selection</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="n">selection</span><span class="p">[</span><span class="mi">3</span><span class="o">*</span><span class="n">ii</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="o">*</span><span class="n">index</span> <span class="o">+</span> <span class="mi">2</span>
            <span class="n">H</span> <span class="o">=</span> <span class="n">Hfull</span><span class="p">[</span><span class="n">selection</span><span class="p">,</span> <span class="n">selection</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            
            <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction</span> <span class="o">!=</span> <span class="s1">&#39;central&#39;</span><span class="p">:</span>
                <span class="n">feq</span> <span class="o">=</span> <span class="n">eq_disp</span><span class="o">.</span><span class="n">forces</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">a</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter_ai</span><span class="p">():</span>
                <span class="n">disp_minus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_disp</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">disp_plus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_disp</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">fminus</span> <span class="o">=</span> <span class="n">disp_minus</span><span class="o">.</span><span class="n">forces</span><span class="p">()</span>
                <span class="n">fplus</span> <span class="o">=</span> <span class="n">disp_plus</span><span class="o">.</span><span class="n">forces</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;frederiksen&#39;</span><span class="p">:</span>
                    <span class="n">fminus</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">-=</span> <span class="n">fminus</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">fplus</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">-=</span> <span class="n">fplus</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfree</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="n">fminusminus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_disp</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">forces</span><span class="p">()</span>
                    <span class="n">fplusplus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_disp</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">forces</span><span class="p">()</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;frederiksen&#39;</span><span class="p">:</span>
                        <span class="n">fminusminus</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">-=</span> <span class="n">fminusminus</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        <span class="n">fplusplus</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">-=</span> <span class="n">fplusplus</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;central&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfree</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                        <span class="n">H</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="mf">.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">fminus</span> <span class="o">-</span> <span class="n">fplus</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfree</span> <span class="o">==</span> <span class="mi">4</span>
                        <span class="n">H</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="n">H</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">fminusminus</span> <span class="o">+</span>
                                    <span class="mi">8</span> <span class="o">*</span> <span class="n">fminus</span> <span class="o">-</span>
                                    <span class="mi">8</span> <span class="o">*</span> <span class="n">fplus</span> <span class="o">+</span>
                                    <span class="n">fplusplus</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span> <span class="o">/</span> <span class="mf">12.0</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;forward&#39;</span><span class="p">:</span>
                    <span class="n">H</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">feq</span> <span class="o">-</span> <span class="n">fplus</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">direction</span> <span class="o">==</span> <span class="s1">&#39;backward&#39;</span>
                    <span class="n">H</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">fminus</span> <span class="o">-</span> <span class="n">feq</span><span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
                <span class="n">H</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">/=</span> <span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span>
                <span class="n">r</span> <span class="o">+=</span> <span class="mi">1</span>

            
        <span class="n">H</span> <span class="o">+=</span> <span class="n">H</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">H</span> <span class="o">=</span> <span class="n">H</span>
            
        <span class="n">masses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">atoms</span><span class="o">.</span><span class="n">get_masses</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">masses</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Zero mass encountered in one or more of &#39;</span>
                               <span class="s1">&#39;the vibrated atoms. Use Atoms.set_masses()&#39;</span>
                               <span class="s1">&#39; to set all masses to non-zero values.&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">im</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">masses</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">indices</span><span class="p">]</span><span class="o">**-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vibrations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_vibrations</span><span class="p">(</span><span class="n">read_cache</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">omega2</span><span class="p">,</span> <span class="n">modes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">H</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">im</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">modes</span> <span class="o">=</span> <span class="n">modes</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Conversion factor:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">_hbar</span> <span class="o">*</span> <span class="mf">1e10</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">_e</span> <span class="o">*</span> <span class="n">units</span><span class="o">.</span><span class="n">_amu</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hnu</span> <span class="o">=</span> <span class="n">s</span> <span class="o">*</span> <span class="n">omega2</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">complex</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
        
        <span class="k">return</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, L.I.Vazquez-Salazar, K. Toepfer &amp; M. Meuwly.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>